
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Generate multilingual taxa pages with OSM maps &#8212; Grasses and sedges of Montserrat (English)</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=9c3e77be" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=1ae7504c"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'generateTaxaPages';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro_en.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="Grasses and sedges of Montserrat (English) - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="Grasses and sedges of Montserrat (English) - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro_en.html">
                    Visible Nature Atlas: Grasses and sedges of Montserrat
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Collections with grasses and sedges from Montserrat</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="organisation/Meise_Botanic_Garden.html">Meise Botanic Garden</a></li>


<li class="toctree-l1"><a class="reference internal" href="organisation/Quentin_Groom.html">Quentin Groom</a></li>

<li class="toctree-l1"><a class="reference internal" href="organisation/Sofie_Meeus.html">Sofie Meeus</a></li>

<li class="toctree-l1"><a class="reference internal" href="organisation/The_New_York_Botanical_Garden.html">The New York Botanical Garden</a></li>















<li class="toctree-l1"><a class="reference internal" href="organisation/University_of_Florida.html">University of Florida</a></li>

<li class="toctree-l1"><a class="reference internal" href="organisation/classical.html">classical</a></li>

<li class="toctree-l1"><a class="reference internal" href="organisation/nan.html">nan</a></li>




















</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Taxa originally from Montserrat</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Andropogon_bicornis.html"><em>Andropogon bicornis</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Anthephora_hermaphrodita.html"><em>Anthephora hermaphrodita</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Aristida_adscensionis.html"><em>Aristida adscensionis</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Axonopus_compressus.html"><em>Axonopus compressus</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Brachiaria_fasciculata.html"><em>Brachiaria fasciculata</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Cenchrus_echinatus.html"><em>Cenchrus echinatus</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Coix_lacryma-jobi.html"><em>Coix lacryma-jobi</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Cymbopogon_citratus.html"><em>Cymbopogon citratus</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Cyperus_alopecuroides.html"><em>Cyperus alopecuroides</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Cyperus_brevifolius.html"><em>Cyperus brevifolius</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Cyperus_sphacelatus.html"><em>Cyperus sphacelatus</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Digitaria_bicornis.html"><em>Digitaria bicornis</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Digitaria_insularis.html"><em>Digitaria insularis</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Eleocharis_flavescens.html"><em>Eleocharis flavescens</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Eriochloa_punctata.html"><em>Eriochloa punctata</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Fimbristylis_complanata.html"><em>Fimbristylis complanata</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Lasiacis_divaricata.html"><em>Lasiacis divaricata</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Lasiacis_sorghoidea.html"><em>Lasiacis sorghoidea</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Machaerina_restioides.html"><em>Machaerina restioides</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Panicum_trichoides.html"><em>Panicum trichoides</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Paspalum_conjugatum.html"><em>Paspalum conjugatum</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Paspalum_fimbriatum.html"><em>Paspalum fimbriatum</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Rhynchospora_nervosa.html"><em>Rhynchospora nervosa</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Rhynchospora_tenerrima.html"><em>Rhynchospora tenerrima</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="taxa_en/Scleria_secans.html"><em>Scleria secans</em></a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/VisibleNatureAtlas/Grasses-and-sedges-of-Montserrat" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/VisibleNatureAtlas/Grasses-and-sedges-of-Montserrat/issues/new?title=Issue%20on%20page%20%2FgenerateTaxaPages.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/generateTaxaPages.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Generate multilingual taxa pages with OSM maps</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-the-local-rdf-graph">Load the local RDF graph</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-functions">Helper functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generate-folium-map-for-a-species">Generate Folium map for a species</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-taxa-information-from-the-rdf-graph">Load taxa information from the RDF graph</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-discover-available-wikipedia-languages">Step 1: Discover available Wikipedia languages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-fetch-language-independent-data-gbif-maps-plazi-bhl">Step 2: Fetch language-independent data (GBIF, maps, Plazi, BHL)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4-generate-montserrat-overview-map-per-language-configs">Step 4: Generate Montserrat overview map + per-language configs</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="generate-multilingual-taxa-pages-with-osm-maps">
<h1>Generate multilingual taxa pages with OSM maps<a class="headerlink" href="#generate-multilingual-taxa-pages-with-osm-maps" title="Link to this heading">#</a></h1>
<p>This notebook generates enriched, multilingual species pages for the Visible Nature Atlas.</p>
<p><strong>For each species, it:</strong></p>
<ol class="arabic simple">
<li><p>Fetches worldwide GBIF occurrence records (with coordinates)</p></li>
<li><p>Generates an interactive Leaflet/OpenStreetMap map</p></li>
<li><p>Discovers available Wikipedia language editions via Wikidata SPARQL</p></li>
<li><p>Fetches Wikipedia introductions <strong>per language</strong></p></li>
<li><p>Fetches Plazi TreatmentBank treatments and BHL literature</p></li>
<li><p>Generates a <strong>Wikipedia language availability table</strong> (which species has articles in which languages)</p></li>
<li><p>Writes complete markdown pages per language: <code class="docutils literal notranslate"><span class="pre">taxa_{lang}/Genus_species.md</span></code></p></li>
<li><p>Generates per-language <code class="docutils literal notranslate"><span class="pre">_config_{lang}.yml</span></code>, <code class="docutils literal notranslate"><span class="pre">_toc_{lang}.yml</span></code>, <code class="docutils literal notranslate"><span class="pre">intro_{lang}.md</span></code></p></li>
<li><p>Creates a landing page (<code class="docutils literal notranslate"><span class="pre">index.html</span></code>) with a language picker</p></li>
</ol>
<p><strong>Prerequisites</strong>: Run <code class="docutils literal notranslate"><span class="pre">inspectData.ipynb</span></code> first to generate <code class="docutils literal notranslate"><span class="pre">gbifMontserrat.ttl</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">folium</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tqdm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">colorsys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rdflib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Graph</span><span class="p">,</span> <span class="n">Namespace</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rdflib.namespace</span><span class="w"> </span><span class="kn">import</span> <span class="n">RDFS</span>

<span class="n">WDT</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span><span class="s2">&quot;http://www.wikidata.org/prop/direct/&quot;</span><span class="p">)</span>
<span class="n">WD</span>  <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span><span class="s2">&quot;http://www.wikidata.org/entity/&quot;</span><span class="p">)</span>

<span class="c1"># BHL API key — set via environment variable or paste here for local testing</span>
<span class="n">BHL_API_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;BHL_API_KEY&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="c1"># Bot-generated Wikipedia editions to exclude (thin/auto-generated content)</span>
<span class="n">BOT_WIKIS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ceb&#39;</span><span class="p">,</span> <span class="s1">&#39;war&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;shn&#39;</span><span class="p">}</span>

<span class="c1"># Minimum number of species that must have a Wikipedia article in a language</span>
<span class="c1"># for that language to get its own book</span>
<span class="n">MIN_SPECIES_PER_LANG</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;maps&#39;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">if</span> <span class="n">BHL_API_KEY</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;BHL API key loaded (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">BHL_API_KEY</span><span class="p">)</span><span class="si">}</span><span class="s1"> chars).&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No BHL_API_KEY set — BHL sections will be skipped.&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dependencies loaded.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="load-the-local-rdf-graph">
<h2>Load the local RDF graph<a class="headerlink" href="#load-the-local-rdf-graph" title="Link to this heading">#</a></h2>
<p>We load <code class="docutils literal notranslate"><span class="pre">gbifMontserrat.ttl</span></code> generated by <code class="docutils literal notranslate"><span class="pre">inspectData.ipynb</span></code> to get the list of species and their Wikidata URIs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">()</span>
<span class="n">g</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;gbifMontserrat.ttl&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;turtle&#39;</span><span class="p">)</span>

<span class="c1"># Extract distinct taxa: {taxon_label: wikidata_qid}</span>
<span class="n">taxa_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">PREFIX wd:  &lt;http://www.wikidata.org/entity/&gt;</span>
<span class="s2">PREFIX wdt: &lt;http://www.wikidata.org/prop/direct/&gt;</span>
<span class="s2">PREFIX rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt;</span>

<span class="s2">SELECT DISTINCT ?taxon ?taxonLabel WHERE {</span>
<span class="s2">    ?obs wdt:P225 ?taxon .</span>
<span class="s2">    ?taxon rdfs:label ?taxonLabel .</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">taxa</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">taxa_query</span><span class="p">):</span>
    <span class="n">qid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">taxon</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;http://www.wikidata.org/entity/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">taxonLabel</span><span class="p">)</span>
    <span class="n">taxa</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;qid&#39;</span><span class="p">:</span> <span class="n">qid</span><span class="p">,</span> <span class="s1">&#39;uri&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">taxon</span><span class="p">)}</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">taxa</span><span class="p">)</span><span class="si">}</span><span class="s1"> distinct taxa:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">taxa</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;qid&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="helper-functions">
<h2>Helper functions<a class="headerlink" href="#helper-functions" title="Link to this heading">#</a></h2>
<p>All data-fetching and utility functions: GBIF occurrences, Wikipedia intros (multilingual),
license resolution, Plazi treatments, BHL publications, and <strong>Wikidata language discovery</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">fetch_gbif_occurrences</span><span class="p">(</span><span class="n">taxon_name</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">300</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetch georeferenced GBIF occurrences for a species by name.&quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://api.gbif.org/v1/occurrence/search&#39;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;scientificName&#39;</span><span class="p">:</span> <span class="n">taxon_name</span><span class="p">,</span>
        <span class="s1">&#39;hasCoordinate&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span>
        <span class="s1">&#39;hasGeospatialIssue&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span>
        <span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="n">limit</span><span class="p">,</span>
        <span class="s1">&#39;offset&#39;</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;decimalLatitude&#39;</span><span class="p">)</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;decimalLongitude&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="n">lat</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="n">lon</span><span class="p">,</span>
                    <span class="s1">&#39;country&#39;</span><span class="p">:</span> <span class="n">rec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;country&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="n">rec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;institution&#39;</span><span class="p">:</span> <span class="n">rec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;institutionCode&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;gbifID&#39;</span><span class="p">:</span> <span class="n">rec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gbifID&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;basisOfRecord&#39;</span><span class="p">:</span> <span class="n">rec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;basisOfRecord&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Warning: could not fetch GBIF occurrences for </span><span class="si">{</span><span class="n">taxon_name</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[],</span> <span class="mi">0</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_wikipedia_intro</span><span class="p">(</span><span class="n">taxon_name</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="s1">&#39;en&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetch the introductory paragraph from Wikipedia in the given language.&quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">.wikipedia.org/w/api.php&#39;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
        <span class="s1">&#39;titles&#39;</span><span class="p">:</span> <span class="n">taxon_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">),</span>
        <span class="s1">&#39;prop&#39;</span><span class="p">:</span> <span class="s1">&#39;extracts&#39;</span><span class="p">,</span> <span class="s1">&#39;exintro&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;explaintext&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;redirects&#39;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">page</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">][</span><span class="s1">&#39;pages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="n">extract</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;extract&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">paragraphs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">extract</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
            <span class="k">return</span> <span class="n">paragraphs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">paragraphs</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">resolve_license_label</span><span class="p">(</span><span class="n">license_uri</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a Wikidata license URI to a (label, url) tuple.&quot;&quot;&quot;</span>
    <span class="n">license_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Q18199165&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;CC BY 4.0&#39;</span><span class="p">,</span>       <span class="s1">&#39;https://creativecommons.org/licenses/by/4.0/&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Q20007257&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;CC BY-SA 4.0&#39;</span><span class="p">,</span>    <span class="s1">&#39;https://creativecommons.org/licenses/by-sa/4.0/&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Q6938433&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="s1">&#39;CC0 1.0&#39;</span><span class="p">,</span>         <span class="s1">&#39;https://creativecommons.org/publicdomain/zero/1.0/&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Q19068220&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;CC BY-NC 4.0&#39;</span><span class="p">,</span>    <span class="s1">&#39;https://creativecommons.org/licenses/by-nc/4.0/&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Q26952697&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;CC BY-NC-SA 4.0&#39;</span><span class="p">,</span> <span class="s1">&#39;https://creativecommons.org/licenses/by-nc-sa/4.0/&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Q35254&#39;</span><span class="p">:</span>    <span class="p">(</span><span class="s1">&#39;CC BY-SA 3.0&#39;</span><span class="p">,</span>    <span class="s1">&#39;https://creativecommons.org/licenses/by-sa/3.0/&#39;</span><span class="p">),</span>
        <span class="s1">&#39;Q24082749&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;CC BY-SA 4.0&#39;</span><span class="p">,</span>    <span class="s1">&#39;https://creativecommons.org/licenses/by-sa/4.0/&#39;</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">license_uri</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;wikidata.org/entity/Q&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">qid</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">qid</span> <span class="ow">in</span> <span class="n">license_map</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">license_map</span><span class="p">[</span><span class="n">qid</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">qid</span><span class="p">,</span> <span class="n">s</span>
    <span class="n">s_lower</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;publicdomain/zero&#39;</span> <span class="ow">in</span> <span class="n">s_lower</span><span class="p">:</span>   <span class="k">return</span> <span class="s1">&#39;CC0 1.0&#39;</span><span class="p">,</span> <span class="n">s</span>
    <span class="k">if</span> <span class="s1">&#39;by-nc-sa&#39;</span> <span class="ow">in</span> <span class="n">s_lower</span><span class="p">:</span>           <span class="k">return</span> <span class="s1">&#39;CC BY-NC-SA 4.0&#39;</span><span class="p">,</span> <span class="n">s</span>
    <span class="k">if</span> <span class="s1">&#39;by-nc&#39;</span> <span class="ow">in</span> <span class="n">s_lower</span><span class="p">:</span>              <span class="k">return</span> <span class="s1">&#39;CC BY-NC 4.0&#39;</span><span class="p">,</span> <span class="n">s</span>
    <span class="k">if</span> <span class="s1">&#39;by-sa&#39;</span> <span class="ow">in</span> <span class="n">s_lower</span><span class="p">:</span>              <span class="k">return</span> <span class="s1">&#39;CC BY-SA 4.0&#39;</span><span class="p">,</span> <span class="n">s</span>
    <span class="k">if</span> <span class="s1">&#39;by&#39;</span> <span class="ow">in</span> <span class="n">s_lower</span><span class="p">:</span>                 <span class="k">return</span> <span class="s1">&#39;CC BY 4.0&#39;</span><span class="p">,</span> <span class="n">s</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">s</span>


<span class="k">def</span><span class="w"> </span><span class="nf">fetch_plazi_treatments</span><span class="p">(</span><span class="n">genus</span><span class="p">,</span> <span class="n">species</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetch taxonomic treatments from Plazi via LINDAS SPARQL endpoint.&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">PREFIX dwc: &lt;http://rs.tdwg.org/dwc/terms/&gt;</span>
<span class="s1">PREFIX dc:  &lt;http://purl.org/dc/elements/1.1/&gt;</span>
<span class="s1">PREFIX treat: &lt;http://plazi.org/vocab/treatment#&gt;</span>

<span class="s1">SELECT DISTINCT ?treatment ?creator</span>
<span class="s1">       (SAMPLE(?title) AS ?pubTitle)</span>
<span class="s1">WHERE {{</span>
<span class="s1">  ?treatment a treat:Treatment .</span>
<span class="s1">  ?treatment (treat:deprecates|treat:augmentsTaxonConcept|treat:definesTaxonConcept) ?tc .</span>
<span class="s1">  ?tc dwc:species &quot;</span><span class="si">{sp}</span><span class="s1">&quot; .</span>
<span class="s1">  ?tc dwc:genus &quot;</span><span class="si">{ge}</span><span class="s1">&quot; .</span>
<span class="s1">  OPTIONAL {{ ?treatment dc:creator ?creator . }}</span>
<span class="s1">  OPTIONAL {{ ?treatment treat:publishedIn ?pub . ?pub dc:title ?title . }}</span>
<span class="s1">}}</span>
<span class="s1">GROUP BY ?treatment ?creator</span>
<span class="s1">LIMIT 10</span>
<span class="s1">&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="n">genus</span><span class="p">,</span> <span class="n">sp</span><span class="o">=</span><span class="n">species</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;https://lindas.admin.ch/query&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="n">query</span><span class="p">},</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/sparql-results+json&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;VisibleNatureAtlas/1.0&#39;</span><span class="p">},</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span>
        <span class="p">)</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bindings&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">t_url</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;treatment&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t_url</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t_url</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;treatment_url&#39;</span><span class="p">:</span> <span class="n">t_url</span><span class="p">,</span>
                <span class="s1">&#39;treatment_page&#39;</span><span class="p">:</span> <span class="n">t_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;http://&#39;</span><span class="p">,</span> <span class="s1">&#39;https://&#39;</span><span class="p">),</span>
                <span class="s1">&#39;creator&#39;</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;creator&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="s1">&#39;pub_title&#39;</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pubTitle&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">results</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Plazi warning for </span><span class="si">{</span><span class="n">genus</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">species</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">fetch_bhl_publications</span><span class="p">(</span><span class="n">taxon_name</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Search BHL for publications mentioning a taxon.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  BHL: skipping </span><span class="si">{</span><span class="n">taxon_name</span><span class="si">}</span><span class="s1"> — no API key&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;https://www.biodiversitylibrary.org/api3&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;PublicationSearch&#39;</span><span class="p">,</span> <span class="s1">&#39;searchterm&#39;</span><span class="p">:</span> <span class="n">taxon_name</span><span class="p">,</span>
                <span class="s1">&#39;searchtype&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;page&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;pagesize&#39;</span><span class="p">:</span> <span class="n">limit</span><span class="p">,</span>
                <span class="s1">&#39;apikey&#39;</span><span class="p">:</span> <span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  BHL HTTP </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">taxon_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Status&#39;</span><span class="p">,</span> <span class="s1">&#39;(missing)&#39;</span><span class="p">)</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ErrorMessage&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">result_raw</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Result&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">n_raw</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_raw</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_raw</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;type=</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">result_raw</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  BHL response: Status=</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s1">, ErrorMessage=</span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s1">, Result count=</span><span class="si">{</span><span class="n">n_raw</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;ok&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  BHL: Status is not &quot;ok&quot; — returning empty for </span><span class="si">{</span><span class="n">taxon_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result_raw</span><span class="p">[:</span><span class="n">limit</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  BHL: unexpected Result item type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">item</span><span class="p">)[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">pub_url</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Url&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pub_url</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TitleID&#39;</span><span class="p">):</span>
                <span class="n">pub_url</span> <span class="o">=</span> <span class="s1">&#39;https://www.biodiversitylibrary.org/title/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;TitleID&#39;</span><span class="p">])</span>
            <span class="c1"># Normalize authors — BHL returns a list of dicts [{Name: ...}, ...]</span>
            <span class="n">raw_authors</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authors&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_authors</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">author_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">raw_authors</span><span class="p">]</span>
                <span class="n">authors_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">author_names</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">authors_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">raw_authors</span><span class="p">)</span> <span class="k">if</span> <span class="n">raw_authors</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Title&#39;</span><span class="p">,</span> <span class="s1">&#39;Untitled&#39;</span><span class="p">),</span>
                <span class="s1">&#39;authors&#39;</span><span class="p">:</span> <span class="n">authors_str</span><span class="p">,</span>
                <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;bhl_url&#39;</span><span class="p">:</span> <span class="n">pub_url</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  BHL: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s1"> publications found for </span><span class="si">{</span><span class="n">taxon_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  BHL error for </span><span class="si">{</span><span class="n">taxon_name</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>




<span class="k">def</span><span class="w"> </span><span class="nf">extract_year</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract a 4-digit year from a publication reference string.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># Try parenthesized year first: &quot;Sp. Pl.: 1050 (1753)&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\((1[5-9]\d</span><span class="si">{2}</span><span class="s1">|20[0-2]\d)\)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="c1"># Try trailing year: &quot;Syst. Nat. ed. 10. 2: 1304. 1759&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b(1[5-9]\d</span><span class="si">{2}</span><span class="s1">|20[0-2]\d)\b&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">fetch_gbif_species_info</span><span class="p">(</span><span class="n">taxon_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetch protologue (original description) and basionym info from GBIF Species API.</span>
<span class="sd">    </span>
<span class="sd">    Returns dict with scientific_name, authorship, published_in (protologue citation),</span>
<span class="sd">    basionym info (if the species was reclassified), and the GBIF usage key.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;scientific_name&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;authorship&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;published_in&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;basionym_name&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;basionym_authorship&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;basionym_published_in&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;gbif_key&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;basionym_year&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Step 1: Match name to get usageKey</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;https://api.gbif.org/v1/species/match&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">taxon_name</span><span class="p">},</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;usageKey&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  GBIF species: no match for </span><span class="si">{</span><span class="n">taxon_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        
        <span class="c1"># Step 2: Get full species record</span>
        <span class="n">resp2</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;https://api.gbif.org/v1/species/</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">resp2</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">detail</span> <span class="o">=</span> <span class="n">resp2</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;scientific_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">detail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scientificName&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;authorship&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">detail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;authorship&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;published_in&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">detail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;publishedIn&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;gbif_key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extract_year</span><span class="p">(</span><span class="n">detail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;publishedIn&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        
        <span class="c1"># Step 3: If there&#39;s a basionym, fetch it</span>
        <span class="n">basionym_key</span> <span class="o">=</span> <span class="n">detail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;basionymKey&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">basionym_key</span> <span class="ow">and</span> <span class="n">basionym_key</span> <span class="o">!=</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">resp3</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;https://api.gbif.org/v1/species/</span><span class="si">{</span><span class="n">basionym_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">resp3</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">bas</span> <span class="o">=</span> <span class="n">resp3</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;basionym_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bas</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scientificName&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;basionym_authorship&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bas</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;authorship&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;basionym_published_in&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bas</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;publishedIn&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;basionym_year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extract_year</span><span class="p">(</span><span class="n">bas</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;publishedIn&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  GBIF species: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;scientific_name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> | published: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;published_in&quot;</span><span class="p">][:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;basionym_name&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;    basionym: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;basionym_name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  GBIF species error for </span><span class="si">{</span><span class="n">taxon_name</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span><span class="w"> </span><span class="nf">fetch_plazi_taxonomic_history</span><span class="p">(</span><span class="n">genus</span><span class="p">,</span> <span class="n">species</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetch deprecated synonyms and taxonomic history from Plazi TreatmentBank.</span>
<span class="sd">    </span>
<span class="sd">    Queries the Plazi SPARQL endpoint for:</span>
<span class="sd">    - Treatments that augment our species AND deprecate an older name (synonymizations)</span>
<span class="sd">    - Treatments that define our species (original descriptions in Plazi)</span>
<span class="sd">    </span>
<span class="sd">    Returns dict with &#39;defines&#39; and &#39;deprecates&#39; lists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;defines&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;deprecates&#39;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">species</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">PREFIX trt: &lt;http://plazi.org/vocab/treatment#&gt;</span>
<span class="s2">PREFIX dc: &lt;http://purl.org/dc/elements/1.1/&gt;</span>
<span class="s2">PREFIX dwc: &lt;http://rs.tdwg.org/dwc/terms/&gt;</span>

<span class="s2">SELECT DISTINCT ?treatment ?type ?depGenus ?depSpecies ?depAuth ?augAuth ?creator ?title WHERE {{</span>
<span class="s2">  ?treatment a trt:Treatment .</span>
<span class="s2">  {{</span>
<span class="s2">    ?treatment trt:augmentsTaxonConcept ?augTc .</span>
<span class="s2">    ?augTc dwc:genus &quot;</span><span class="si">{ge}</span><span class="s2">&quot; .</span>
<span class="s2">    ?augTc dwc:species &quot;</span><span class="si">{sp}</span><span class="s2">&quot; .</span>
<span class="s2">    OPTIONAL {{ ?augTc dwc:scientificNameAuthorship ?augAuth }}</span>
<span class="s2">    ?treatment trt:deprecates ?depTc .</span>
<span class="s2">    ?depTc dwc:genus ?depGenus .</span>
<span class="s2">    ?depTc dwc:species ?depSpecies .</span>
<span class="s2">    OPTIONAL {{ ?depTc dwc:scientificNameAuthorship ?depAuth }}</span>
<span class="s2">    OPTIONAL {{ ?treatment dc:creator ?creator }}</span>
<span class="s2">    OPTIONAL {{ ?treatment dc:title ?title }}</span>
<span class="s2">    BIND(&quot;deprecates&quot; AS ?type)</span>
<span class="s2">  }} UNION {{</span>
<span class="s2">    ?treatment trt:definesTaxonConcept ?tc .</span>
<span class="s2">    ?tc dwc:genus &quot;</span><span class="si">{ge}</span><span class="s2">&quot; .</span>
<span class="s2">    ?tc dwc:species &quot;</span><span class="si">{sp}</span><span class="s2">&quot; .</span>
<span class="s2">    OPTIONAL {{ ?tc dwc:scientificNameAuthorship ?augAuth }}</span>
<span class="s2">    OPTIONAL {{ ?treatment dc:creator ?creator }}</span>
<span class="s2">    OPTIONAL {{ ?treatment dc:title ?title }}</span>
<span class="s2">    BIND(&quot;defines&quot; AS ?type)</span>
<span class="s2">  }}</span>
<span class="s2">}}</span>
<span class="s2">LIMIT 30</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="n">genus</span><span class="p">,</span> <span class="n">sp</span><span class="o">=</span><span class="n">species</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;https://treatment.ld.plazi.org/sparql&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="n">query</span><span class="p">},</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/sparql-results+json&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;VisibleNatureAtlas/1.0&#39;</span><span class="p">},</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span>
        <span class="p">)</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        
        <span class="n">seen_deprecated</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bindings&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">t_type</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">t_url</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;treatment&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;http://&#39;</span><span class="p">,</span> <span class="s1">&#39;https://&#39;</span><span class="p">)</span>
            <span class="n">creator</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;creator&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">t_type</span> <span class="o">==</span> <span class="s1">&#39;defines&#39;</span><span class="p">:</span>
                <span class="n">aug_auth</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;augAuth&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;defines&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;treatment_url&#39;</span><span class="p">:</span> <span class="n">t_url</span><span class="p">,</span>
                    <span class="s1">&#39;creator&#39;</span><span class="p">:</span> <span class="n">creator</span><span class="p">,</span>
                    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
                    <span class="s1">&#39;auth&#39;</span><span class="p">:</span> <span class="n">aug_auth</span><span class="p">,</span>
                <span class="p">})</span>
            <span class="k">elif</span> <span class="n">t_type</span> <span class="o">==</span> <span class="s1">&#39;deprecates&#39;</span><span class="p">:</span>
                <span class="n">dep_genus</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;depGenus&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">dep_species</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;depSpecies&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">dep_auth</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;depAuth&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">dep_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dep_genus</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">dep_species</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="c1"># Deduplicate by deprecated name</span>
                <span class="k">if</span> <span class="n">dep_name</span> <span class="ow">in</span> <span class="n">seen_deprecated</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">seen_deprecated</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dep_name</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;deprecates&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;deprecated_name&#39;</span><span class="p">:</span> <span class="n">dep_name</span><span class="p">,</span>
                    <span class="s1">&#39;deprecated_auth&#39;</span><span class="p">:</span> <span class="n">dep_auth</span><span class="p">,</span>
                    <span class="s1">&#39;treatment_url&#39;</span><span class="p">:</span> <span class="n">t_url</span><span class="p">,</span>
                    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
                    <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="n">extract_year</span><span class="p">(</span><span class="n">dep_auth</span><span class="p">)</span> <span class="ow">or</span> <span class="n">extract_year</span><span class="p">(</span><span class="n">title</span><span class="p">),</span>
                <span class="p">})</span>
        
        <span class="n">n_dep</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;deprecates&#39;</span><span class="p">])</span>
        <span class="n">n_def</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;defines&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">n_dep</span> <span class="ow">or</span> <span class="n">n_def</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Plazi history: </span><span class="si">{</span><span class="n">genus</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">species</span><span class="si">}</span><span class="s1"> — </span><span class="si">{</span><span class="n">n_def</span><span class="si">}</span><span class="s1"> defines, </span><span class="si">{</span><span class="n">n_dep</span><span class="si">}</span><span class="s1"> deprecated synonyms&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Plazi history error for </span><span class="si">{</span><span class="n">genus</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">species</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span><span class="w"> </span><span class="nf">fetch_plazi_figures</span><span class="p">(</span><span class="n">genus</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetch figure images cited in Plazi TreatmentBank treatments.</span>
<span class="sd">    </span>
<span class="sd">    Queries the Plazi SPARQL endpoint (not LINDAS) for figures linked</span>
<span class="sd">    via cito:cites to treatments matching the given genus/species.</span>
<span class="sd">    Figures are fabio:Figure resources with image URLs on Zenodo/Pensoft.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">species</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">PREFIX trt: &lt;http://plazi.org/vocab/treatment#&gt;</span>
<span class="s2">PREFIX fabio: &lt;http://purl.org/spar/fabio/&gt;</span>
<span class="s2">PREFIX dc: &lt;http://purl.org/dc/elements/1.1/&gt;</span>
<span class="s2">PREFIX dwc: &lt;http://rs.tdwg.org/dwc/terms/&gt;</span>
<span class="s2">PREFIX cito: &lt;http://purl.org/spar/cito/&gt;</span>

<span class="s2">SELECT DISTINCT ?treatment ?figure ?imageUrl ?description WHERE {{</span>
<span class="s2">  ?treatment a trt:Treatment .</span>
<span class="s2">  {{ ?treatment trt:augmentsTaxonConcept ?tc }}</span>
<span class="s2">  UNION</span>
<span class="s2">  {{ ?treatment trt:definesTaxonConcept ?tc }}</span>
<span class="s2">  UNION</span>
<span class="s2">  {{ ?treatment trt:deprecates ?tc }}</span>
<span class="s2">  ?tc dwc:genus &quot;</span><span class="si">{ge}</span><span class="s2">&quot; .</span>
<span class="s2">  ?tc dwc:species &quot;</span><span class="si">{sp}</span><span class="s2">&quot; .</span>
<span class="s2">  ?treatment cito:cites ?figure .</span>
<span class="s2">  ?figure a fabio:Figure .</span>
<span class="s2">  ?figure fabio:hasRepresentation ?imageUrl .</span>
<span class="s2">  OPTIONAL {{ ?figure dc:description ?description . }}</span>
<span class="s2">}}</span>
<span class="s2">LIMIT </span><span class="si">{lim}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="n">genus</span><span class="p">,</span> <span class="n">sp</span><span class="o">=</span><span class="n">species</span><span class="p">,</span> <span class="n">lim</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;https://treatment.ld.plazi.org/sparql&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="n">query</span><span class="p">},</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/sparql-results+json&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;VisibleNatureAtlas/1.0&#39;</span><span class="p">},</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span>
        <span class="p">)</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">seen_urls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bindings&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">image_url</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;imageUrl&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">image_url</span> <span class="ow">or</span> <span class="n">image_url</span> <span class="ow">in</span> <span class="n">seen_urls</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">seen_urls</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">image_url</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;treatment_url&#39;</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;treatment&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;http://&#39;</span><span class="p">,</span> <span class="s1">&#39;https://&#39;</span><span class="p">),</span>
                <span class="s1">&#39;figure_doi&#39;</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figure&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="s1">&#39;image_url&#39;</span><span class="p">:</span> <span class="n">image_url</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">results</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Plazi figures warning for </span><span class="si">{</span><span class="n">genus</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">species</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">discover_wikipedia_languages</span><span class="p">(</span><span class="n">qids</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Discover available Wikipedia editions for a set of Wikidata items.</span>
<span class="sd">    </span>
<span class="sd">    Uses Wikidata SPARQL to find all sitelinks in one query.</span>
<span class="sd">    Returns dict: {taxon_label: {lang_code: article_title, ...}, ...}</span>
<span class="sd">    and a reverse map: {lang_code: set of taxon_labels with articles}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Build VALUES clause with QIDs</span>
    <span class="n">values</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;wd:</span><span class="si">{</span><span class="n">qid</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">qid</span> <span class="ow">in</span> <span class="n">qids</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    
    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">SELECT ?item ?itemLabel ?sitelink ?site WHERE </span><span class="se">{{</span>
<span class="s1">  VALUES ?item </span><span class="se">{{</span><span class="s1"> </span><span class="si">{</span><span class="n">values</span><span class="si">}</span><span class="s1"> </span><span class="se">}}</span>
<span class="s1">  ?sitelink schema:about ?item ;</span>
<span class="s1">            schema:isPartOf ?site ;</span>
<span class="s1">            schema:name ?name .</span>
<span class="s1">  ?site wikibase:wikiGroup &quot;wikipedia&quot; .</span>
<span class="s1">  SERVICE wikibase:label </span><span class="se">{{</span><span class="s1"> bd:serviceParam wikibase:language &quot;en&quot; . </span><span class="se">}}</span>
<span class="se">}}</span>
<span class="s1">&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;https://query.wikidata.org/sparql&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;json&#39;</span><span class="p">},</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;VisibleNatureAtlas/1.0 (https://github.com/VisibleNatureAtlas)&#39;</span><span class="p">},</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span>
        <span class="p">)</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Warning: Wikidata language discovery failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Fallback: just return English</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;en&#39;</span><span class="p">:</span> <span class="n">label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)}</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">qids</span><span class="o">.</span><span class="n">keys</span><span class="p">()},</span> <span class="p">{</span><span class="s1">&#39;en&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">qids</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
    
    <span class="c1"># Build QID → label reverse lookup</span>
    <span class="n">qid_to_label</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">qids</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    
    <span class="c1"># Parse results</span>
    <span class="n">taxon_langs</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># {taxon_label: {lang: article_title}}</span>
    <span class="n">lang_taxa</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1"># {lang: set(taxon_labels)}</span>
    
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bindings&#39;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="n">item_uri</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">qid</span> <span class="o">=</span> <span class="n">item_uri</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">taxon_label</span> <span class="o">=</span> <span class="n">qid_to_label</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">taxon_label</span><span class="p">:</span>
            <span class="k">continue</span>
        
        <span class="n">site_url</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;site&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1"># Extract language code from site URL like https://en.wikipedia.org/</span>
        <span class="k">if</span> <span class="s1">&#39;.wikipedia.org&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">site_url</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="n">site_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;//&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;//&#39;</span> <span class="ow">in</span> <span class="n">site_url</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lang</span> <span class="ow">or</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">BOT_WIKIS</span><span class="p">:</span>
            <span class="k">continue</span>
        
        <span class="n">sitelink_url</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sitelink&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">article_title</span> <span class="o">=</span> <span class="n">sitelink_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/wiki/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;/wiki/&#39;</span> <span class="ow">in</span> <span class="n">sitelink_url</span> <span class="k">else</span> <span class="n">taxon_label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">taxon_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">taxon_langs</span><span class="p">:</span>
            <span class="n">taxon_langs</span><span class="p">[</span><span class="n">taxon_label</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">taxon_langs</span><span class="p">[</span><span class="n">taxon_label</span><span class="p">][</span><span class="n">lang</span><span class="p">]</span> <span class="o">=</span> <span class="n">article_title</span>
        
        <span class="k">if</span> <span class="n">lang</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lang_taxa</span><span class="p">:</span>
            <span class="n">lang_taxa</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">lang_taxa</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">taxon_label</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">taxon_langs</span><span class="p">,</span> <span class="n">lang_taxa</span>


<span class="c1"># Language names for display (ISO 639-1 → English name)</span>
<span class="n">LANG_NAMES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;en&#39;</span><span class="p">:</span> <span class="s1">&#39;English&#39;</span><span class="p">,</span> <span class="s1">&#39;fr&#39;</span><span class="p">:</span> <span class="s1">&#39;French&#39;</span><span class="p">,</span> <span class="s1">&#39;de&#39;</span><span class="p">:</span> <span class="s1">&#39;German&#39;</span><span class="p">,</span> <span class="s1">&#39;es&#39;</span><span class="p">:</span> <span class="s1">&#39;Spanish&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pt&#39;</span><span class="p">:</span> <span class="s1">&#39;Portuguese&#39;</span><span class="p">,</span> <span class="s1">&#39;it&#39;</span><span class="p">:</span> <span class="s1">&#39;Italian&#39;</span><span class="p">,</span> <span class="s1">&#39;nl&#39;</span><span class="p">:</span> <span class="s1">&#39;Dutch&#39;</span><span class="p">,</span> <span class="s1">&#39;sv&#39;</span><span class="p">:</span> <span class="s1">&#39;Swedish&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pl&#39;</span><span class="p">:</span> <span class="s1">&#39;Polish&#39;</span><span class="p">,</span> <span class="s1">&#39;ru&#39;</span><span class="p">:</span> <span class="s1">&#39;Russian&#39;</span><span class="p">,</span> <span class="s1">&#39;ja&#39;</span><span class="p">:</span> <span class="s1">&#39;Japanese&#39;</span><span class="p">,</span> <span class="s1">&#39;zh&#39;</span><span class="p">:</span> <span class="s1">&#39;Chinese&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ko&#39;</span><span class="p">:</span> <span class="s1">&#39;Korean&#39;</span><span class="p">,</span> <span class="s1">&#39;ar&#39;</span><span class="p">:</span> <span class="s1">&#39;Arabic&#39;</span><span class="p">,</span> <span class="s1">&#39;ca&#39;</span><span class="p">:</span> <span class="s1">&#39;Catalan&#39;</span><span class="p">,</span> <span class="s1">&#39;cs&#39;</span><span class="p">:</span> <span class="s1">&#39;Czech&#39;</span><span class="p">,</span>
    <span class="s1">&#39;da&#39;</span><span class="p">:</span> <span class="s1">&#39;Danish&#39;</span><span class="p">,</span> <span class="s1">&#39;fi&#39;</span><span class="p">:</span> <span class="s1">&#39;Finnish&#39;</span><span class="p">,</span> <span class="s1">&#39;el&#39;</span><span class="p">:</span> <span class="s1">&#39;Greek&#39;</span><span class="p">,</span> <span class="s1">&#39;he&#39;</span><span class="p">:</span> <span class="s1">&#39;Hebrew&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hi&#39;</span><span class="p">:</span> <span class="s1">&#39;Hindi&#39;</span><span class="p">,</span> <span class="s1">&#39;hu&#39;</span><span class="p">:</span> <span class="s1">&#39;Hungarian&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;Indonesian&#39;</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">:</span> <span class="s1">&#39;Malay&#39;</span><span class="p">,</span>
    <span class="s1">&#39;no&#39;</span><span class="p">:</span> <span class="s1">&#39;Norwegian&#39;</span><span class="p">,</span> <span class="s1">&#39;fa&#39;</span><span class="p">:</span> <span class="s1">&#39;Persian&#39;</span><span class="p">,</span> <span class="s1">&#39;ro&#39;</span><span class="p">:</span> <span class="s1">&#39;Romanian&#39;</span><span class="p">,</span> <span class="s1">&#39;sk&#39;</span><span class="p">:</span> <span class="s1">&#39;Slovak&#39;</span><span class="p">,</span>
    <span class="s1">&#39;th&#39;</span><span class="p">:</span> <span class="s1">&#39;Thai&#39;</span><span class="p">,</span> <span class="s1">&#39;tr&#39;</span><span class="p">:</span> <span class="s1">&#39;Turkish&#39;</span><span class="p">,</span> <span class="s1">&#39;uk&#39;</span><span class="p">:</span> <span class="s1">&#39;Ukrainian&#39;</span><span class="p">,</span> <span class="s1">&#39;vi&#39;</span><span class="p">:</span> <span class="s1">&#39;Vietnamese&#39;</span><span class="p">,</span>
    <span class="s1">&#39;eu&#39;</span><span class="p">:</span> <span class="s1">&#39;Basque&#39;</span><span class="p">,</span> <span class="s1">&#39;gl&#39;</span><span class="p">:</span> <span class="s1">&#39;Galician&#39;</span><span class="p">,</span> <span class="s1">&#39;hr&#39;</span><span class="p">:</span> <span class="s1">&#39;Croatian&#39;</span><span class="p">,</span> <span class="s1">&#39;lt&#39;</span><span class="p">:</span> <span class="s1">&#39;Lithuanian&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lv&#39;</span><span class="p">:</span> <span class="s1">&#39;Latvian&#39;</span><span class="p">,</span> <span class="s1">&#39;sr&#39;</span><span class="p">:</span> <span class="s1">&#39;Serbian&#39;</span><span class="p">,</span> <span class="s1">&#39;sl&#39;</span><span class="p">:</span> <span class="s1">&#39;Slovenian&#39;</span><span class="p">,</span> <span class="s1">&#39;bg&#39;</span><span class="p">:</span> <span class="s1">&#39;Bulgarian&#39;</span><span class="p">,</span>
    <span class="s1">&#39;et&#39;</span><span class="p">:</span> <span class="s1">&#39;Estonian&#39;</span><span class="p">,</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span> <span class="s1">&#39;Simple English&#39;</span><span class="p">,</span> <span class="s1">&#39;nb&#39;</span><span class="p">:</span> <span class="s1">&#39;Norwegian Bokm</span><span class="se">\u00e5</span><span class="s1">l&#39;</span><span class="p">,</span>
    <span class="s1">&#39;nn&#39;</span><span class="p">:</span> <span class="s1">&#39;Norwegian Nynorsk&#39;</span><span class="p">,</span> <span class="s1">&#39;eo&#39;</span><span class="p">:</span> <span class="s1">&#39;Esperanto&#39;</span><span class="p">,</span> <span class="s1">&#39;az&#39;</span><span class="p">:</span> <span class="s1">&#39;Azerbaijani&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ta&#39;</span><span class="p">:</span> <span class="s1">&#39;Tamil&#39;</span><span class="p">,</span> <span class="s1">&#39;te&#39;</span><span class="p">:</span> <span class="s1">&#39;Telugu&#39;</span><span class="p">,</span> <span class="s1">&#39;bn&#39;</span><span class="p">:</span> <span class="s1">&#39;Bengali&#39;</span><span class="p">,</span> <span class="s1">&#39;ur&#39;</span><span class="p">:</span> <span class="s1">&#39;Urdu&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pa&#39;</span><span class="p">:</span> <span class="s1">&#39;Punjabi&#39;</span><span class="p">,</span> <span class="s1">&#39;ml&#39;</span><span class="p">:</span> <span class="s1">&#39;Malayalam&#39;</span><span class="p">,</span> <span class="s1">&#39;kn&#39;</span><span class="p">:</span> <span class="s1">&#39;Kannada&#39;</span><span class="p">,</span> <span class="s1">&#39;gu&#39;</span><span class="p">:</span> <span class="s1">&#39;Gujarati&#39;</span><span class="p">,</span>
    <span class="s1">&#39;mr&#39;</span><span class="p">:</span> <span class="s1">&#39;Marathi&#39;</span><span class="p">,</span> <span class="s1">&#39;af&#39;</span><span class="p">:</span> <span class="s1">&#39;Afrikaans&#39;</span><span class="p">,</span> <span class="s1">&#39;sw&#39;</span><span class="p">:</span> <span class="s1">&#39;Swahili&#39;</span><span class="p">,</span> <span class="s1">&#39;ga&#39;</span><span class="p">:</span> <span class="s1">&#39;Irish&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cy&#39;</span><span class="p">:</span> <span class="s1">&#39;Welsh&#39;</span><span class="p">,</span> <span class="s1">&#39;la&#39;</span><span class="p">:</span> <span class="s1">&#39;Latin&#39;</span><span class="p">,</span> <span class="s1">&#39;sh&#39;</span><span class="p">:</span> <span class="s1">&#39;Serbo-Croatian&#39;</span><span class="p">,</span> <span class="s1">&#39;ast&#39;</span><span class="p">:</span> <span class="s1">&#39;Asturian&#39;</span><span class="p">,</span>
    <span class="s1">&#39;oc&#39;</span><span class="p">:</span> <span class="s1">&#39;Occitan&#39;</span><span class="p">,</span> <span class="s1">&#39;an&#39;</span><span class="p">:</span> <span class="s1">&#39;Aragonese&#39;</span><span class="p">,</span> <span class="s1">&#39;mg&#39;</span><span class="p">:</span> <span class="s1">&#39;Malagasy&#39;</span><span class="p">,</span> <span class="s1">&#39;tl&#39;</span><span class="p">:</span> <span class="s1">&#39;Tagalog&#39;</span><span class="p">,</span>
    <span class="s1">&#39;qu&#39;</span><span class="p">:</span> <span class="s1">&#39;Quechua&#39;</span><span class="p">,</span> <span class="s1">&#39;nds&#39;</span><span class="p">:</span> <span class="s1">&#39;Low German&#39;</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_lang_name</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the English name for a language code, or the code itself.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">LANG_NAMES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;All helper functions defined (including multilingual + Plazi + BHL).&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="generate-folium-map-for-a-species">
<h2>Generate Folium map for a species<a class="headerlink" href="#generate-folium-map-for-a-species" title="Link to this heading">#</a></h2>
<p>Creates an interactive OpenStreetMap map with clustered observation markers.
Returns the path to the saved HTML file (embedded in the markdown page).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">generate_species_map</span><span class="p">(</span><span class="n">taxon_name</span><span class="p">,</span> <span class="n">occurrences</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a Folium map with observation points and save as HTML.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        taxon_name: Scientific name of the species</span>
<span class="sd">        occurrences: List of occurrence dicts with lat, lon, country, year, institution, gbifID</span>
<span class="sd">        output_path: Path to save the HTML map file</span>
<span class="sd">    Returns:</span>
<span class="sd">        Path to the saved HTML file, or None if no occurrences</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">occurrences</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Compute centroid for initial map view</span>
    <span class="n">lats</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">occurrences</span><span class="p">]</span>
    <span class="n">lons</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">occurrences</span><span class="p">]</span>
    <span class="n">center</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">),</span> <span class="nb">sum</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">)]</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span>
        <span class="n">location</span><span class="o">=</span><span class="n">center</span><span class="p">,</span>
        <span class="n">zoom_start</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">tiles</span><span class="o">=</span><span class="s1">&#39;OpenStreetMap&#39;</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="s1">&#39;100%&#39;</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="s1">&#39;450px&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Add tile layer attribution</span>
    <span class="n">folium</span><span class="o">.</span><span class="n">TileLayer</span><span class="p">(</span>
        <span class="n">tiles</span><span class="o">=</span><span class="s1">&#39;https://</span><span class="si">{s}</span><span class="s1">.tile.openstreetmap.org/</span><span class="si">{z}</span><span class="s1">/</span><span class="si">{x}</span><span class="s1">/</span><span class="si">{y}</span><span class="s1">.png&#39;</span><span class="p">,</span>
        <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;© &lt;a href=&quot;https://www.openstreetmap.org/copyright&quot;&gt;OpenStreetMap&lt;/a&gt; contributors&#39;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;OpenStreetMap&#39;</span><span class="p">,</span>
        <span class="n">overlay</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">control</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="c1"># Colour-code by basis of record</span>
    <span class="n">color_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;HUMAN_OBSERVATION&#39;</span><span class="p">:</span> <span class="s1">&#39;#2ecc71&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PRESERVED_SPECIMEN&#39;</span><span class="p">:</span> <span class="s1">&#39;#e67e22&#39;</span><span class="p">,</span>
        <span class="s1">&#39;MACHINE_OBSERVATION&#39;</span><span class="p">:</span> <span class="s1">&#39;#3498db&#39;</span><span class="p">,</span>
        <span class="s1">&#39;LITERATURE&#39;</span><span class="p">:</span> <span class="s1">&#39;#9b59b6&#39;</span><span class="p">,</span>
        <span class="s1">&#39;MATERIAL_SAMPLE&#39;</span><span class="p">:</span> <span class="s1">&#39;#e74c3c&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">occ</span> <span class="ow">in</span> <span class="n">occurrences</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">color_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">occ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;basisOfRecord&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="s1">&#39;#95a5a6&#39;</span><span class="p">)</span>
        <span class="n">year_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">occ</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">occ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">inst_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;br&gt;&lt;em&gt;</span><span class="si">{</span><span class="n">occ</span><span class="p">[</span><span class="s1">&#39;institution&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/em&gt;&quot;</span> <span class="k">if</span> <span class="n">occ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;institution&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">gbif_link</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">occ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gbifID&#39;</span><span class="p">):</span>
            <span class="n">gbif_link</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&lt;br&gt;&lt;a href=&quot;https://www.gbif.org/occurrence/</span><span class="si">{</span><span class="n">occ</span><span class="p">[</span><span class="s2">&quot;gbifID&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot; target=&quot;_blank&quot;&gt;GBIF record&lt;/a&gt;&#39;</span>
        
        <span class="n">popup_html</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;b&gt;</span><span class="si">{</span><span class="n">taxon_name</span><span class="si">}</span><span class="s2">&lt;/b&gt;&lt;br&gt;&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">occ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;country&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}{</span><span class="n">year_str</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">inst_str</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gbif_link</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">folium</span><span class="o">.</span><span class="n">CircleMarker</span><span class="p">(</span>
            <span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="n">occ</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">occ</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]],</span>
            <span class="n">radius</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">fill_color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="n">fill_opacity</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="n">popup</span><span class="o">=</span><span class="n">folium</span><span class="o">.</span><span class="n">Popup</span><span class="p">(</span><span class="n">popup_html</span><span class="p">,</span> <span class="n">max_width</span><span class="o">=</span><span class="mi">250</span><span class="p">),</span>
            <span class="n">tooltip</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">occ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;country&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">year_str</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="c1"># Legend</span>
    <span class="n">legend_html</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    &lt;div style=&quot;position:fixed; bottom:20px; left:20px; z-index:9999;</span>
<span class="s1">                background:white; padding:10px; border-radius:6px;</span>
<span class="s1">                border:1px solid #ccc; font-size:12px; line-height:1.8;&quot;&gt;</span>
<span class="s1">        &lt;b&gt;Basis of record&lt;/b&gt;&lt;br&gt;</span>
<span class="s1">        &lt;span style=&quot;color:#2ecc71;&quot;&gt;●&lt;/span&gt; Human observation&lt;br&gt;</span>
<span class="s1">        &lt;span style=&quot;color:#e67e22;&quot;&gt;●&lt;/span&gt; Preserved specimen&lt;br&gt;</span>
<span class="s1">        &lt;span style=&quot;color:#3498db;&quot;&gt;●&lt;/span&gt; Machine observation&lt;br&gt;</span>
<span class="s1">        &lt;span style=&quot;color:#9b59b6;&quot;&gt;●&lt;/span&gt; Literature&lt;br&gt;</span>
<span class="s1">        &lt;span style=&quot;color:#95a5a6;&quot;&gt;●&lt;/span&gt; Other</span>
<span class="s1">    &lt;/div&gt;</span>
<span class="s1">    &#39;&#39;&#39;</span>
    <span class="n">m</span><span class="o">.</span><span class="n">get_root</span><span class="p">()</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">folium</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="n">legend_html</span><span class="p">))</span>

    <span class="n">m</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_path</span>


<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Map generation function defined.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-taxa-information-from-the-rdf-graph">
<h2>Load taxa information from the RDF graph<a class="headerlink" href="#load-taxa-information-from-the-rdf-graph" title="Link to this heading">#</a></h2>
<p>Extract taxon data from <code class="docutils literal notranslate"><span class="pre">gbifMontserrat.ttl</span></code> — observations grouped by publisher,
with media URLs and license information.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Query the local RDF graph for all observation data</span>
<span class="n">obs_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">PREFIX wd:  &lt;http://www.wikidata.org/entity/&gt;</span>
<span class="s2">PREFIX wdt: &lt;http://www.wikidata.org/prop/direct/&gt;</span>
<span class="s2">PREFIX rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt;</span>
<span class="s2">PREFIX dc:   &lt;http://purl.org/dc/elements/1.1/&gt;</span>

<span class="s2">SELECT DISTINCT ?taxon ?taxonLabel ?publisher ?publisherLabel </span>
<span class="s2">                ?observation ?gbifObservation ?media_url ?license WHERE {</span>
<span class="s2">    ?media wdt:P2699 ?media_url ;</span>
<span class="s2">           wdt:P275 ?license ;</span>
<span class="s2">           wdt:P361 ?observation .</span>
<span class="s2">    ?observation wdt:P225 ?taxon ;</span>
<span class="s2">                 wdt:P854 ?gbifObservation ;</span>
<span class="s2">                 wdt:P123 ?publisher .</span>
<span class="s2">    ?taxon rdfs:label ?taxonLabel .</span>
<span class="s2">    ?publisher rdfs:label ?publisherLabel .</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># Build taxonpages: {taxon_label: {qid, publisher: {org: [{obs_id, media, license}]}}}</span>
<span class="n">taxonpages</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">obs_query</span><span class="p">):</span>
    <span class="n">taxon_label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">taxonLabel</span><span class="p">)</span>
    <span class="n">qid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">taxon</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;http://www.wikidata.org/entity/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">publisherLabel</span><span class="p">)</span>
    <span class="n">obs_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">gbifObservation</span><span class="p">)</span>
    <span class="n">media_url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">media_url</span><span class="p">)</span>
    <span class="n">license_uri</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">license</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">taxon_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">taxonpages</span><span class="p">:</span>
        <span class="n">taxonpages</span><span class="p">[</span><span class="n">taxon_label</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;qid&#39;</span><span class="p">:</span> <span class="n">qid</span><span class="p">,</span> <span class="s1">&#39;uri&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">taxon</span><span class="p">),</span> <span class="s1">&#39;publishers&#39;</span><span class="p">:</span> <span class="p">{}}</span>
    
    <span class="k">if</span> <span class="n">publisher</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">taxonpages</span><span class="p">[</span><span class="n">taxon_label</span><span class="p">][</span><span class="s1">&#39;publishers&#39;</span><span class="p">]:</span>
        <span class="n">taxonpages</span><span class="p">[</span><span class="n">taxon_label</span><span class="p">][</span><span class="s1">&#39;publishers&#39;</span><span class="p">][</span><span class="n">publisher</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">if</span> <span class="n">obs_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">taxonpages</span><span class="p">[</span><span class="n">taxon_label</span><span class="p">][</span><span class="s1">&#39;publishers&#39;</span><span class="p">][</span><span class="n">publisher</span><span class="p">]:</span>
        <span class="n">taxonpages</span><span class="p">[</span><span class="n">taxon_label</span><span class="p">][</span><span class="s1">&#39;publishers&#39;</span><span class="p">][</span><span class="n">publisher</span><span class="p">][</span><span class="n">obs_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;obs_id&#39;</span><span class="p">:</span> <span class="n">obs_id</span><span class="p">,</span>
            <span class="s1">&#39;media&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;license&#39;</span><span class="p">:</span> <span class="n">license_uri</span>
        <span class="p">}</span>
    
    <span class="k">if</span> <span class="n">media_url</span> <span class="ow">and</span> <span class="n">media_url</span> <span class="o">!=</span> <span class="s1">&#39;nan&#39;</span><span class="p">:</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="n">taxonpages</span><span class="p">[</span><span class="n">taxon_label</span><span class="p">][</span><span class="s1">&#39;publishers&#39;</span><span class="p">][</span><span class="n">publisher</span><span class="p">][</span><span class="n">obs_id</span><span class="p">][</span><span class="s1">&#39;media&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">media_url</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing</span><span class="p">:</span>
            <span class="n">existing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">media_url</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">taxonpages</span><span class="p">)</span><span class="si">}</span><span class="s1"> taxa with observation data.&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">taxonpages</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="n">n_obs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span> <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">taxonpages</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;publishers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">taxonpages</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;publishers&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1"> publishers, </span><span class="si">{</span><span class="n">n_obs</span><span class="si">}</span><span class="s1"> observations&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-1-discover-available-wikipedia-languages">
<h2>Step 1: Discover available Wikipedia languages<a class="headerlink" href="#step-1-discover-available-wikipedia-languages" title="Link to this heading">#</a></h2>
<p>Query Wikidata SPARQL for all Wikipedia sitelinks of our species. This determines
which languages will get their own Jupyter Book edition.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build QID map: {taxon_label: QID}</span>
<span class="n">qid_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;qid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">taxa</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Discovering Wikipedia language editions for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">qid_map</span><span class="p">)</span><span class="si">}</span><span class="s1"> taxa via Wikidata SPARQL...&#39;</span><span class="p">)</span>
<span class="n">taxon_langs</span><span class="p">,</span> <span class="n">lang_taxa</span> <span class="o">=</span> <span class="n">discover_wikipedia_languages</span><span class="p">(</span><span class="n">qid_map</span><span class="p">)</span>

<span class="c1"># Filter languages with enough species coverage</span>
<span class="n">active_langs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">lang</span><span class="p">:</span> <span class="n">species_set</span>
    <span class="k">for</span> <span class="n">lang</span><span class="p">,</span> <span class="n">species_set</span> <span class="ow">in</span> <span class="n">lang_taxa</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">species_set</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MIN_SPECIES_PER_LANG</span>
<span class="p">}</span>

<span class="c1"># Always include English even if it falls below threshold</span>
<span class="k">if</span> <span class="s1">&#39;en&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">active_langs</span> <span class="ow">and</span> <span class="s1">&#39;en&#39;</span> <span class="ow">in</span> <span class="n">lang_taxa</span><span class="p">:</span>
    <span class="n">active_langs</span><span class="p">[</span><span class="s1">&#39;en&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lang_taxa</span><span class="p">[</span><span class="s1">&#39;en&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Wikipedia language availability:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">active_langs</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_langs</span><span class="p">[</span><span class="n">l</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_langs</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  </span><span class="si">{</span><span class="n">lang</span><span class="si">:</span><span class="s1">&gt;8s</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">get_lang_name</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span><span class="si">:</span><span class="s1">&gt;20s</span><span class="si">}</span><span class="s1">): </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">taxonpages</span><span class="p">)</span><span class="si">}</span><span class="s1"> species&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">active_langs</span><span class="p">)</span><span class="si">}</span><span class="s1"> languages with &gt;= </span><span class="si">{</span><span class="n">MIN_SPECIES_PER_LANG</span><span class="si">}</span><span class="s1"> species articles (+ English).&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Filtered out bot wikis: </span><span class="si">{</span><span class="n">BOT_WIKIS</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-2-fetch-language-independent-data-gbif-maps-plazi-bhl">
<h2>Step 2: Fetch language-independent data (GBIF, maps, Plazi, BHL)<a class="headerlink" href="#step-2-fetch-language-independent-data-gbif-maps-plazi-bhl" title="Link to this heading">#</a></h2>
<p>These are fetched once — they don’t depend on language. We store the results
in <code class="docutils literal notranslate"><span class="pre">shared_data[taxon_name]</span></code> for reuse across all language editions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">shared_data</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">taxon_name</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">taxonpages</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Fetching shared data&#39;</span><span class="p">):</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">taxonpages</span><span class="p">[</span><span class="n">taxon_name</span><span class="p">]</span>
    <span class="n">qid</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;qid&#39;</span><span class="p">]</span>
    <span class="n">safe_name</span> <span class="o">=</span> <span class="n">taxon_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
    
    <span class="c1"># GBIF occurrences</span>
    <span class="n">occurrences</span><span class="p">,</span> <span class="n">total_count</span> <span class="o">=</span> <span class="n">fetch_gbif_occurrences</span><span class="p">(</span><span class="n">taxon_name</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    
    <span class="c1"># Generate map</span>
    <span class="n">map_path</span> <span class="o">=</span> <span class="s1">&#39;maps/&#39;</span> <span class="o">+</span> <span class="n">safe_name</span> <span class="o">+</span> <span class="s1">&#39;.html&#39;</span>
    <span class="n">generate_species_map</span><span class="p">(</span><span class="n">taxon_name</span><span class="p">,</span> <span class="n">occurrences</span><span class="p">,</span> <span class="n">map_path</span><span class="p">)</span>
    
    <span class="c1"># Plazi treatments</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">taxon_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">genus</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">species</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="n">treatments</span> <span class="o">=</span> <span class="n">fetch_plazi_treatments</span><span class="p">(</span><span class="n">genus</span><span class="p">,</span> <span class="n">species</span><span class="p">)</span> <span class="k">if</span> <span class="n">species</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># BHL publications</span>
    <span class="n">bhl_pubs</span> <span class="o">=</span> <span class="n">fetch_bhl_publications</span><span class="p">(</span><span class="n">taxon_name</span><span class="p">,</span> <span class="n">BHL_API_KEY</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># Plazi treatment figures (from Plazi SPARQL, not LINDAS)</span>
    <span class="n">plazi_figures</span> <span class="o">=</span> <span class="n">fetch_plazi_figures</span><span class="p">(</span><span class="n">genus</span><span class="p">,</span> <span class="n">species</span><span class="p">)</span> <span class="k">if</span> <span class="n">species</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># GBIF species info (protologue / original description, basionym)</span>
    <span class="n">gbif_species</span> <span class="o">=</span> <span class="n">fetch_gbif_species_info</span><span class="p">(</span><span class="n">taxon_name</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># Plazi taxonomic history (deprecated synonyms, name changes)</span>
    <span class="n">taxon_history</span> <span class="o">=</span> <span class="n">fetch_plazi_taxonomic_history</span><span class="p">(</span><span class="n">genus</span><span class="p">,</span> <span class="n">species</span><span class="p">)</span> <span class="k">if</span> <span class="n">species</span> <span class="k">else</span> <span class="p">{</span><span class="s1">&#39;defines&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;deprecates&#39;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">shared_data</span><span class="p">[</span><span class="n">taxon_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;qid&#39;</span><span class="p">:</span> <span class="n">qid</span><span class="p">,</span>
        <span class="s1">&#39;safe_name&#39;</span><span class="p">:</span> <span class="n">safe_name</span><span class="p">,</span>
        <span class="s1">&#39;occurrences&#39;</span><span class="p">:</span> <span class="n">occurrences</span><span class="p">,</span>
        <span class="s1">&#39;total_count&#39;</span><span class="p">:</span> <span class="n">total_count</span><span class="p">,</span>
        <span class="s1">&#39;treatments&#39;</span><span class="p">:</span> <span class="n">treatments</span><span class="p">,</span>
        <span class="s1">&#39;bhl_pubs&#39;</span><span class="p">:</span> <span class="n">bhl_pubs</span><span class="p">,</span>
        <span class="s1">&#39;plazi_figures&#39;</span><span class="p">:</span> <span class="n">plazi_figures</span><span class="p">,</span>
        <span class="s1">&#39;gbif_species&#39;</span><span class="p">:</span> <span class="n">gbif_species</span><span class="p">,</span>
        <span class="s1">&#39;taxon_history&#39;</span><span class="p">:</span> <span class="n">taxon_history</span><span class="p">,</span>
        <span class="s1">&#39;map_path&#39;</span><span class="p">:</span> <span class="n">map_path</span><span class="p">,</span>
    <span class="p">}</span>

<span class="c1"># Summary of BHL results</span>
<span class="n">bhl_total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">shared_data</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">sd</span><span class="p">[</span><span class="s1">&#39;bhl_pubs&#39;</span><span class="p">])</span>
<span class="n">bhl_pubs_total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sd</span><span class="p">[</span><span class="s1">&#39;bhl_pubs&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">shared_data</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Shared data fetched for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">shared_data</span><span class="p">)</span><span class="si">}</span><span class="s1"> species.&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;BHL summary: </span><span class="si">{</span><span class="n">bhl_total</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">shared_data</span><span class="p">)</span><span class="si">}</span><span class="s1"> species have BHL publications (</span><span class="si">{</span><span class="n">bhl_pubs_total</span><span class="si">}</span><span class="s1"> total)&#39;</span><span class="p">)</span>
<span class="c1"># Taxonomic history summary</span>
<span class="n">gbif_proto</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">shared_data</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">sd</span><span class="p">[</span><span class="s1">&#39;gbif_species&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;published_in&#39;</span><span class="p">))</span>
<span class="n">gbif_basio</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">shared_data</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">sd</span><span class="p">[</span><span class="s1">&#39;gbif_species&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;basionym_name&#39;</span><span class="p">))</span>
<span class="n">plazi_hist</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">shared_data</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">sd</span><span class="p">[</span><span class="s1">&#39;taxon_history&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;deprecates&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;GBIF species: </span><span class="si">{</span><span class="n">gbif_proto</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">shared_data</span><span class="p">)</span><span class="si">}</span><span class="s1"> with protologue, </span><span class="si">{</span><span class="n">gbif_basio</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">shared_data</span><span class="p">)</span><span class="si">}</span><span class="s1"> with basionym&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Taxonomic history: </span><span class="si">{</span><span class="n">plazi_hist</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">shared_data</span><span class="p">)</span><span class="si">}</span><span class="s1"> species with deprecated synonyms&#39;</span><span class="p">)</span>

<span class="n">fig_total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">shared_data</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">sd</span><span class="p">[</span><span class="s1">&#39;plazi_figures&#39;</span><span class="p">])</span>
<span class="n">fig_count_total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sd</span><span class="p">[</span><span class="s1">&#39;plazi_figures&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">shared_data</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Plazi figures: </span><span class="si">{</span><span class="n">fig_total</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">shared_data</span><span class="p">)</span><span class="si">}</span><span class="s1"> species have figures (</span><span class="si">{</span><span class="n">fig_count_total</span><span class="si">}</span><span class="s1"> total)&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">tn</span><span class="p">,</span> <span class="n">sd</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">shared_data</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">n_bhl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sd</span><span class="p">[</span><span class="s1">&#39;bhl_pubs&#39;</span><span class="p">])</span>
    <span class="n">n_fig</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sd</span><span class="p">[</span><span class="s1">&#39;plazi_figures&#39;</span><span class="p">])</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">n_bhl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n_bhl</span><span class="si">}</span><span class="s1"> BHL publications&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_fig</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n_fig</span><span class="si">}</span><span class="s1"> Plazi figures&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parts</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s1">: no BHL publications or Plazi figures&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ---- Generate Wikipedia language availability table ----</span>
<span class="c1"># This table shows which species have Wikipedia articles in which languages.</span>
<span class="c1"># It will be included in the intro page of each language edition.</span>

<span class="k">def</span><span class="w"> </span><span class="nf">generate_wikipedia_lang_table</span><span class="p">(</span><span class="n">taxon_langs</span><span class="p">,</span> <span class="n">active_langs</span><span class="p">,</span> <span class="n">all_taxa</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a markdown table showing Wikipedia coverage per species per language.</span>
<span class="sd">    </span>
<span class="sd">    Rows = species (sorted), Columns = active languages (sorted by coverage).</span>
<span class="sd">    Cells = checkmark or dash.</span>
<span class="sd">    Returns markdown string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Sort languages by coverage (descending), then alphabetically</span>
    <span class="n">sorted_langs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="n">active_langs</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">active_langs</span><span class="p">[</span><span class="n">l</span><span class="p">]),</span> <span class="n">l</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">sorted_taxa</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_taxa</span><span class="p">)</span>
    
    <span class="c1"># Header row</span>
    <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;| Species |&#39;</span>
    <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;|---------|&#39;</span>
    <span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">sorted_langs</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">get_lang_name</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">) |&#39;</span>
        <span class="n">separator</span> <span class="o">+=</span> <span class="s1">&#39;:-:|&#39;</span>
    
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">header</span><span class="p">,</span> <span class="n">separator</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">taxon</span> <span class="ow">in</span> <span class="n">sorted_taxa</span><span class="p">:</span>
        <span class="n">langs_for_taxon</span> <span class="o">=</span> <span class="n">taxon_langs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">taxon</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">row</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;| *</span><span class="si">{</span><span class="n">taxon</span><span class="si">}</span><span class="s1">* |&#39;</span>
        <span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">sorted_langs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">langs_for_taxon</span><span class="p">:</span>
                <span class="c1"># Link to Wikipedia article</span>
                <span class="n">article</span> <span class="o">=</span> <span class="n">langs_for_taxon</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
                <span class="n">wp_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">.wikipedia.org/wiki/</span><span class="si">{</span><span class="n">article</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; [</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">](</span><span class="si">{</span><span class="n">wp_url</span><span class="si">}</span><span class="s1">) |&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="s1">&#39; — |&#39;</span>
        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>


<span class="n">wiki_table_md</span> <span class="o">=</span> <span class="n">generate_wikipedia_lang_table</span><span class="p">(</span><span class="n">taxon_langs</span><span class="p">,</span> <span class="n">active_langs</span><span class="p">,</span> <span class="n">taxonpages</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wikipedia language availability table generated.&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Table: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">taxonpages</span><span class="p">)</span><span class="si">}</span><span class="s1"> species x </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">active_langs</span><span class="p">)</span><span class="si">}</span><span class="s1"> languages&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ---- Pre-fetch all Wikipedia intros across all languages ----</span>
<span class="c1"># Fetch once, store in wiki_intros[lang][taxon_name] = intro_text</span>
<span class="c1"># This avoids repeated fetches and reduces total API calls</span>

<span class="n">wiki_intros</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># {lang: {taxon_name: intro_text}}</span>

<span class="n">total_fetches</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
    <span class="mi">1</span> <span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">active_langs</span>
    <span class="k">for</span> <span class="n">tn</span> <span class="ow">in</span> <span class="n">taxonpages</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">taxon_langs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tn</span><span class="p">,</span> <span class="p">{})</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Pre-fetching </span><span class="si">{</span><span class="n">total_fetches</span><span class="si">}</span><span class="s1"> Wikipedia intros across </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">active_langs</span><span class="p">)</span><span class="si">}</span><span class="s1"> languages...&#39;</span><span class="p">)</span>

<span class="n">fetch_count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">active_langs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Fetching Wikipedia intros&#39;</span><span class="p">):</span>
    <span class="n">wiki_intros</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">for</span> <span class="n">taxon_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">taxonpages</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">taxon_langs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">taxon_name</span><span class="p">,</span> <span class="p">{}):</span>
            <span class="k">continue</span>
        
        <span class="n">article_title</span> <span class="o">=</span> <span class="n">taxon_langs</span><span class="p">[</span><span class="n">taxon_name</span><span class="p">][</span><span class="n">lang</span><span class="p">]</span>
        <span class="n">intro</span> <span class="o">=</span> <span class="n">get_wikipedia_intro</span><span class="p">(</span><span class="n">article_title</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="n">lang</span><span class="p">)</span>
        <span class="n">wiki_intros</span><span class="p">[</span><span class="n">lang</span><span class="p">][</span><span class="n">taxon_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">intro</span>
        <span class="n">fetch_count</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Polite rate limiting: short sleep every 10 requests</span>
        <span class="k">if</span> <span class="n">fetch_count</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fetched </span><span class="si">{</span><span class="n">fetch_count</span><span class="si">}</span><span class="s1"> Wikipedia intros.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ---- Step 3: Generate per-language taxa pages (using pre-fetched intros) ----</span>

<span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">active_langs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Generating language editions&#39;</span><span class="p">):</span>
    <span class="n">lang_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;taxa_</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">lang_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">lang_name</span> <span class="o">=</span> <span class="n">get_lang_name</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- </span><span class="si">{</span><span class="n">lang_name</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">) ---&#39;</span><span class="p">)</span>
    
    <span class="n">toc_taxa_lang</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">taxon_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">taxonpages</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">taxonpages</span><span class="p">[</span><span class="n">taxon_name</span><span class="p">]</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="n">shared_data</span><span class="p">[</span><span class="n">taxon_name</span><span class="p">]</span>
        <span class="n">qid</span> <span class="o">=</span> <span class="n">sd</span><span class="p">[</span><span class="s1">&#39;qid&#39;</span><span class="p">]</span>
        <span class="n">safe_name</span> <span class="o">=</span> <span class="n">sd</span><span class="p">[</span><span class="s1">&#39;safe_name&#39;</span><span class="p">]</span>
        <span class="n">occurrences</span> <span class="o">=</span> <span class="n">sd</span><span class="p">[</span><span class="s1">&#39;occurrences&#39;</span><span class="p">]</span>
        <span class="n">total_count</span> <span class="o">=</span> <span class="n">sd</span><span class="p">[</span><span class="s1">&#39;total_count&#39;</span><span class="p">]</span>
        <span class="n">treatments</span> <span class="o">=</span> <span class="n">sd</span><span class="p">[</span><span class="s1">&#39;treatments&#39;</span><span class="p">]</span>
        <span class="n">bhl_pubs</span> <span class="o">=</span> <span class="n">sd</span><span class="p">[</span><span class="s1">&#39;bhl_pubs&#39;</span><span class="p">]</span>
        <span class="n">plazi_figures</span> <span class="o">=</span> <span class="n">sd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plazi_figures&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">gbif_species</span> <span class="o">=</span> <span class="n">sd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gbif_species&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">taxon_history</span> <span class="o">=</span> <span class="n">sd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;taxon_history&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;defines&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;deprecates&#39;</span><span class="p">:</span> <span class="p">[]})</span>
        
        <span class="c1"># Use pre-fetched Wikipedia intro</span>
        <span class="n">has_wiki</span> <span class="o">=</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">taxon_langs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">taxon_name</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">wiki_intro</span> <span class="o">=</span> <span class="n">wiki_intros</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">taxon_name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="c1"># Write markdown page</span>
        <span class="n">page_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lang_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">safe_name</span><span class="si">}</span><span class="s1">.md&#39;</span>
        <span class="n">toc_taxa_lang</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lang_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">safe_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
        
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Title</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;# *</span><span class="si">{</span><span class="n">taxon_name</span><span class="si">}</span><span class="s1">*&#39;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="c1"># Wikidata / Scholia / GBIF link bar</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;[Wikidata (</span><span class="si">{</span><span class="n">qid</span><span class="si">}</span><span class="s1">)](https://www.wikidata.org/wiki/</span><span class="si">{</span><span class="n">qid</span><span class="si">}</span><span class="s1">) </span><span class="se">\u00b7</span><span class="s1"> &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;[Scholia](https://scholia.toolforge.org/taxon/</span><span class="si">{</span><span class="n">qid</span><span class="si">}</span><span class="s1">) </span><span class="se">\u00b7</span><span class="s1"> &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;[GBIF](https://www.gbif.org/species/search?q=</span><span class="si">{</span><span class="n">taxon_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;%20&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="c1"># Wikipedia introduction</span>
        <span class="k">if</span> <span class="n">wiki_intro</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;## About this species&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wiki_intro</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">article</span> <span class="o">=</span> <span class="n">taxon_langs</span><span class="p">[</span><span class="n">taxon_name</span><span class="p">][</span><span class="n">lang</span><span class="p">]</span>
            <span class="n">wp_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">.wikipedia.org/wiki/</span><span class="si">{</span><span class="n">article</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Read more on [</span><span class="si">{</span><span class="n">lang_name</span><span class="si">}</span><span class="s1"> Wikipedia](</span><span class="si">{</span><span class="n">wp_url</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">has_wiki</span><span class="p">:</span>
            <span class="n">article</span> <span class="o">=</span> <span class="n">taxon_langs</span><span class="p">[</span><span class="n">taxon_name</span><span class="p">][</span><span class="n">lang</span><span class="p">]</span>
            <span class="n">wp_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">.wikipedia.org/wiki/</span><span class="si">{</span><span class="n">article</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Read about this species on [</span><span class="si">{</span><span class="n">lang_name</span><span class="si">}</span><span class="s1"> Wikipedia](</span><span class="si">{</span><span class="n">wp_url</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="c1"># Other language editions</span>
        <span class="n">other_langs</span> <span class="o">=</span> <span class="p">{</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">taxon_langs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">taxon_name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="n">lang</span> <span class="ow">and</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">active_langs</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">other_langs</span><span class="p">:</span>
            <span class="n">lang_links</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ol</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">other_langs</span><span class="p">):</span>
                <span class="n">article</span> <span class="o">=</span> <span class="n">taxon_langs</span><span class="p">[</span><span class="n">taxon_name</span><span class="p">][</span><span class="n">ol</span><span class="p">]</span>
                <span class="n">lang_links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">get_lang_name</span><span class="p">(</span><span class="n">ol</span><span class="p">)</span><span class="si">}</span><span class="s1">](https://</span><span class="si">{</span><span class="n">ol</span><span class="si">}</span><span class="s1">.wikipedia.org/wiki/</span><span class="si">{</span><span class="n">article</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Also available in: &#39;</span> <span class="o">+</span> <span class="s1">&#39; </span><span class="se">\u00b7</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lang_links</span><span class="p">))</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="c1"># Original description section</span>
        <span class="k">if</span> <span class="n">gbif_species</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;published_in&#39;</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;## Original description&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">auth</span> <span class="o">=</span> <span class="n">gbif_species</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;authorship&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">published</span> <span class="o">=</span> <span class="n">gbif_species</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;published_in&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">gbif_key</span> <span class="o">=</span> <span class="n">gbif_species</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gbif_key&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;*</span><span class="si">{</span><span class="n">taxon_name</span><span class="si">}</span><span class="s1">* was first described by **</span><span class="si">{</span><span class="n">auth</span><span class="si">}</span><span class="s1">** in:&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&gt; </span><span class="si">{</span><span class="n">published</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            
            <span class="c1"># If there&#39;s a basionym, explain the reclassification</span>
            <span class="n">bas_name</span> <span class="o">=</span> <span class="n">gbif_species</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;basionym_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bas_name</span><span class="p">:</span>
                <span class="n">bas_auth</span> <span class="o">=</span> <span class="n">gbif_species</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;basionym_authorship&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">bas_pub</span> <span class="o">=</span> <span class="n">gbif_species</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;basionym_published_in&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;This species was originally described as *</span><span class="si">{</span><span class="n">bas_name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s2">&quot; &quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">bas_name</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">bas_name</span><span class="si">}</span><span class="s1">* &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">bas_auth</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">bas_pub</span><span class="si">}</span><span class="s1">, and was later reclassified to its current name.&#39;</span>
                <span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">gbif_key</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[View on GBIF](https://www.gbif.org/species/</span><span class="si">{</span><span class="n">gbif_key</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="c1"># Taxonomic history timeline</span>
        <span class="n">history_events</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Add basionym as first event (original name)</span>
        <span class="k">if</span> <span class="n">gbif_species</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;basionym_name&#39;</span><span class="p">):</span>
            <span class="n">bas_year</span> <span class="o">=</span> <span class="n">gbif_species</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;basionym_year&#39;</span><span class="p">)</span>
            <span class="n">bas_name</span> <span class="o">=</span> <span class="n">gbif_species</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;basionym_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">bas_pub</span> <span class="o">=</span> <span class="n">gbif_species</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;basionym_published_in&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">history_events</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="n">bas_year</span><span class="p">,</span>
                <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="s1">&#39;First described&#39;</span><span class="p">,</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">bas_name</span><span class="p">,</span>
                <span class="s1">&#39;reference&#39;</span><span class="p">:</span> <span class="n">bas_pub</span><span class="p">,</span>
                <span class="s1">&#39;link&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="k">elif</span> <span class="n">gbif_species</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;published_in&#39;</span><span class="p">):</span>
            <span class="c1"># No basionym — species was described under its current name</span>
            <span class="n">sp_year</span> <span class="o">=</span> <span class="n">gbif_species</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)</span>
            <span class="n">sp_name</span> <span class="o">=</span> <span class="n">gbif_species</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scientific_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">sp_pub</span> <span class="o">=</span> <span class="n">gbif_species</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;published_in&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">history_events</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="n">sp_year</span><span class="p">,</span>
                <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="s1">&#39;First described&#39;</span><span class="p">,</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">sp_name</span><span class="p">,</span>
                <span class="s1">&#39;reference&#39;</span><span class="p">:</span> <span class="n">sp_pub</span><span class="p">,</span>
                <span class="s1">&#39;link&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="p">})</span>
        
        <span class="c1"># Add reclassification to current name (if basionym exists)</span>
        <span class="k">if</span> <span class="n">gbif_species</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;basionym_name&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">gbif_species</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;published_in&#39;</span><span class="p">):</span>
            <span class="n">sp_year</span> <span class="o">=</span> <span class="n">gbif_species</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)</span>
            <span class="n">sp_name</span> <span class="o">=</span> <span class="n">gbif_species</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scientific_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">sp_pub</span> <span class="o">=</span> <span class="n">gbif_species</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;published_in&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">history_events</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="n">sp_year</span><span class="p">,</span>
                <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="s1">&#39;Reclassified&#39;</span><span class="p">,</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">sp_name</span><span class="p">,</span>
                <span class="s1">&#39;reference&#39;</span><span class="p">:</span> <span class="n">sp_pub</span><span class="p">,</span>
                <span class="s1">&#39;link&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="p">})</span>
        
        <span class="c1"># Add deprecated synonyms from Plazi</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">taxon_history</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;deprecates&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">dep_name</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;deprecated_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">dep_auth</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;deprecated_auth&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">dep_year</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)</span>
            <span class="n">t_url</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;treatment_url&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">full_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dep_name</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">dep_auth</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">dep_auth</span> <span class="k">else</span> <span class="n">dep_name</span>
            <span class="n">history_events</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="n">dep_year</span><span class="p">,</span>
                <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="s1">&#39;Synonym deprecated&#39;</span><span class="p">,</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">full_name</span><span class="p">,</span>
                <span class="s1">&#39;reference&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;link&#39;</span><span class="p">:</span> <span class="n">t_url</span><span class="p">,</span>
            <span class="p">})</span>
        
        <span class="c1"># Add original descriptions from Plazi</span>
        <span class="k">for</span> <span class="n">defn</span> <span class="ow">in</span> <span class="n">taxon_history</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;defines&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">auth</span> <span class="o">=</span> <span class="n">defn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">defn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">t_url</span> <span class="o">=</span> <span class="n">defn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;treatment_url&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">def_year</span> <span class="o">=</span> <span class="n">extract_year</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span> <span class="ow">or</span> <span class="n">extract_year</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="n">history_events</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="n">def_year</span><span class="p">,</span>
                <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="s1">&#39;Original description (Plazi)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">taxon_name</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">auth</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                <span class="s1">&#39;reference&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
                <span class="s1">&#39;link&#39;</span><span class="p">:</span> <span class="n">t_url</span><span class="p">,</span>
            <span class="p">})</span>
        
        <span class="c1"># Only show timeline if there are at least 2 events (otherwise it&#39;s trivial)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">history_events</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># Sort by year (None values go last)</span>
            <span class="n">history_events</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">9999</span><span class="p">,</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">]))</span>
            
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;## Taxonomic history&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;| Year | Event | Name | Reference |&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;|------|-------|------|-----------|&#39;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">evt</span> <span class="ow">in</span> <span class="n">history_events</span><span class="p">:</span>
                <span class="n">year_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">evt</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">evt</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;</span><span class="se">\u2014</span><span class="s1">&#39;</span>
                <span class="n">event_str</span> <span class="o">=</span> <span class="n">evt</span><span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">]</span>
                <span class="n">name_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;*</span><span class="si">{</span><span class="n">evt</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">*&#39;</span> <span class="k">if</span> <span class="n">evt</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                <span class="n">ref_str</span> <span class="o">=</span> <span class="n">evt</span><span class="p">[</span><span class="s1">&#39;reference&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">evt</span><span class="p">[</span><span class="s1">&#39;link&#39;</span><span class="p">]:</span>
                    <span class="n">ref_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;[Plazi treatment](</span><span class="si">{</span><span class="n">evt</span><span class="p">[</span><span class="s2">&quot;link&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span>
                    <span class="k">if</span> <span class="n">evt</span><span class="p">[</span><span class="s1">&#39;reference&#39;</span><span class="p">]:</span>
                        <span class="n">ref_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">evt</span><span class="p">[</span><span class="s2">&quot;reference&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="se">\u2014</span><span class="s1"> </span><span class="si">{</span><span class="n">ref_str</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;| </span><span class="si">{</span><span class="n">year_str</span><span class="si">}</span><span class="s1"> | </span><span class="si">{</span><span class="n">event_str</span><span class="si">}</span><span class="s1"> | </span><span class="si">{</span><span class="n">name_str</span><span class="si">}</span><span class="s1"> | </span><span class="si">{</span><span class="n">ref_str</span><span class="si">}</span><span class="s1"> |&#39;</span><span class="p">)</span>
            
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="c1"># Map section</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;## Global distribution&#39;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">occurrences</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Map shows **</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">occurrences</span><span class="p">)</span><span class="si">}</span><span class="s1">** georeferenced GBIF records &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;(out of </span><span class="si">{</span><span class="n">total_count</span><span class="si">}</span><span class="s1"> total) for *</span><span class="si">{</span><span class="n">taxon_name</span><span class="si">}</span><span class="s1">* worldwide. &#39;</span>
                <span class="s1">&#39;Click markers for details.&#39;</span>
            <span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;```</span><span class="si">{raw}</span><span class="s1"> html&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&lt;iframe src=&quot;../maps/</span><span class="si">{</span><span class="n">safe_name</span><span class="si">}</span><span class="s1">.html&quot; width=&quot;100%&quot; height=&quot;500px&quot; &#39;</span>
                         <span class="s1">&#39;frameborder=&quot;0&quot; scrolling=&quot;no&quot; &#39;</span>
                         <span class="s1">&#39;style=&quot;border-radius:8px; margin-bottom:1rem;&quot;&gt;&lt;/iframe&gt;&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;```&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s1">&#39;Map data </span><span class="se">\u00a9</span><span class="s1"> [OpenStreetMap](https://www.openstreetmap.org/copyright) contributors. &#39;</span>
                <span class="s1">&#39;Occurrence data from [GBIF](https://www.gbif.org/).&#39;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;*No georeferenced occurrence records found in GBIF for this species.*&#39;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="c1"># Plazi TreatmentBank section</span>
        <span class="k">if</span> <span class="n">treatments</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;## Taxonomic treatments&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Taxonomic treatments from [Plazi TreatmentBank](https://plazi.org/treatmentbank/):&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">treatments</span><span class="p">:</span>
                <span class="n">tr_url</span> <span class="o">=</span> <span class="n">tr</span><span class="p">[</span><span class="s1">&#39;treatment_page&#39;</span><span class="p">]</span>
                <span class="n">creator</span> <span class="o">=</span> <span class="n">tr</span><span class="p">[</span><span class="s1">&#39;creator&#39;</span><span class="p">]</span>
                <span class="n">pub</span> <span class="o">=</span> <span class="n">tr</span><span class="p">[</span><span class="s1">&#39;pub_title&#39;</span><span class="p">]</span>
                <span class="n">label_parts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">creator</span><span class="p">:</span>
                    <span class="n">label_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">creator</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pub</span><span class="p">:</span>
                    <span class="n">label_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;*</span><span class="si">{</span><span class="n">pub</span><span class="si">}</span><span class="s1">*&#39;</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39; </span><span class="se">\u2014</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label_parts</span><span class="p">)</span> <span class="k">if</span> <span class="n">label_parts</span> <span class="k">else</span> <span class="s1">&#39;Treatment&#39;</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- [</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">](</span><span class="si">{</span><span class="n">tr_url</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">syno_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://synospecies.plazi.org/#</span><span class="si">{</span><span class="n">taxon_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;%20&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[View all treatments for *</span><span class="si">{</span><span class="n">taxon_name</span><span class="si">}</span><span class="s1">* on Synospecies](</span><span class="si">{</span><span class="n">syno_url</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="c1"># Plazi treatment figures section</span>
        <span class="k">if</span> <span class="n">plazi_figures</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;## Figures from taxonomic treatments&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s1">&#39;Figures extracted from taxonomic publications by &#39;</span>
                <span class="s1">&#39;[Plazi TreatmentBank](https://plazi.org/treatmentbank/) &#39;</span>
                <span class="s1">&#39;and deposited in open repositories.&#39;</span>
            <span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fig</span> <span class="ow">in</span> <span class="n">plazi_figures</span><span class="p">:</span>
                <span class="n">image_url</span> <span class="o">=</span> <span class="n">fig</span><span class="p">[</span><span class="s1">&#39;image_url&#39;</span><span class="p">]</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">figure_doi</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figure_doi&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="c1"># Use description as alt text (truncated for alt attribute)</span>
                <span class="n">alt_text</span> <span class="o">=</span> <span class="n">description</span><span class="p">[:</span><span class="mi">120</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">description</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">120</span> <span class="k">else</span> <span class="n">description</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">alt_text</span><span class="p">:</span>
                    <span class="n">alt_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">taxon_name</span><span class="si">}</span><span class="s1"> — figure from taxonomic treatment&#39;</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;![</span><span class="si">{</span><span class="n">alt_text</span><span class="si">}</span><span class="s1">](</span><span class="si">{</span><span class="n">image_url</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="c1"># Caption with description and source link</span>
                <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;*</span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s1">*&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">figure_doi</span><span class="p">:</span>
                    <span class="n">doi_url</span> <span class="o">=</span> <span class="n">figure_doi</span> <span class="k">if</span> <span class="n">figure_doi</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;https://doi.org/</span><span class="si">{</span><span class="n">figure_doi</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[Source](</span><span class="si">{</span><span class="n">doi_url</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="c1"># BHL Literature section</span>
        <span class="k">if</span> <span class="n">bhl_pubs</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;## Literature&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Publications from the [Biodiversity Heritage Library](https://www.biodiversitylibrary.org/):&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pub</span> <span class="ow">in</span> <span class="n">bhl_pubs</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">pub</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">pub</span><span class="p">[</span><span class="s1">&#39;bhl_url&#39;</span><span class="p">]</span>
                <span class="n">authors</span> <span class="o">=</span> <span class="n">pub</span><span class="p">[</span><span class="s1">&#39;authors&#39;</span><span class="p">]</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">pub</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
                <span class="n">suffix_parts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">authors</span><span class="p">:</span>
                    <span class="c1"># BHL API returns Authors as a list of dicts, not a string</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">authors</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">author_names</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">authors</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                                <span class="n">author_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">author_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
                        <span class="n">suffix_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">author_names</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">suffix_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">authors</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">date</span><span class="p">:</span>
                    <span class="n">suffix_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="p">))</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39; </span><span class="se">\u2014</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">suffix_parts</span><span class="p">)</span> <span class="k">if</span> <span class="n">suffix_parts</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- [</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">](</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s1">)</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">bhl_search</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://www.biodiversitylibrary.org/search?SearchTerm=</span><span class="si">{</span><span class="n">taxon_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;+&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[Search for *</span><span class="si">{</span><span class="n">taxon_name</span><span class="si">}</span><span class="s1">* on BHL](</span><span class="si">{</span><span class="n">bhl_search</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="c1"># Observations from Montserrat</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;## Observations from Montserrat&#39;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Observations from the GBIF dataset covering Montserrat grasses and sedges.&#39;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">org_name</span><span class="p">,</span> <span class="n">obs_dict</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;publishers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;### </span><span class="si">{</span><span class="n">org_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">obs_id</span><span class="p">,</span> <span class="n">obs_data</span> <span class="ow">in</span> <span class="n">obs_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">license_label</span><span class="p">,</span> <span class="n">license_url</span> <span class="o">=</span> <span class="n">resolve_license_label</span><span class="p">(</span><span class="n">obs_data</span><span class="p">[</span><span class="s1">&#39;license&#39;</span><span class="p">])</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;**Observation:** [</span><span class="si">{</span><span class="n">obs_id</span><span class="si">}</span><span class="s1">](</span><span class="si">{</span><span class="n">obs_id</span><span class="si">}</span><span class="s1">)  &#39;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;**License:** [</span><span class="si">{</span><span class="n">license_label</span><span class="si">}</span><span class="s1">](</span><span class="si">{</span><span class="n">license_url</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">media_url</span> <span class="ow">in</span> <span class="n">obs_data</span><span class="p">[</span><span class="s1">&#39;media&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">media_url</span> <span class="ow">and</span> <span class="n">media_url</span> <span class="o">!=</span> <span class="s1">&#39;nan&#39;</span><span class="p">:</span>
                        <span class="n">display_url</span> <span class="o">=</span> <span class="n">media_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;square&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">)</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;![</span><span class="si">{</span><span class="n">taxon_name</span><span class="si">}</span><span class="s1"> </span><span class="se">\u2014</span><span class="s1"> </span><span class="si">{</span><span class="n">org_name</span><span class="si">}</span><span class="s1">](</span><span class="si">{</span><span class="n">display_url</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">page_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Generated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">toc_taxa_lang</span><span class="p">)</span><span class="si">}</span><span class="s1"> pages in </span><span class="si">{</span><span class="n">lang_dir</span><span class="si">}</span><span class="s1">/&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">All language editions generated.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-4-generate-montserrat-overview-map-per-language-configs">
<h2>Step 4: Generate Montserrat overview map + per-language configs<a class="headerlink" href="#step-4-generate-montserrat-overview-map-per-language-configs" title="Link to this heading">#</a></h2>
<p>Generate the overview map (shared across all languages), then create
<code class="docutils literal notranslate"><span class="pre">_config_{lang}.yml</span></code>, <code class="docutils literal notranslate"><span class="pre">_toc_{lang}.yml</span></code>, <code class="docutils literal notranslate"><span class="pre">intro_{lang}.md</span></code>, and the landing page.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ---- Montserrat overview map (shared, language-independent) ----</span>

<span class="n">df_occ</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s1">&#39;data/0002020-240626123714530/occurrence.txt&#39;</span><span class="p">,</span>
    <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">on_bad_lines</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="n">df_coords</span> <span class="o">=</span> <span class="n">df_occ</span><span class="p">[</span>
    <span class="n">df_occ</span><span class="p">[</span><span class="s1">&#39;decimalLatitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span>
    <span class="n">df_occ</span><span class="p">[</span><span class="s1">&#39;decimalLongitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">df_occ</span><span class="p">[</span><span class="s1">&#39;taxonRank&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SPECIES&#39;</span><span class="p">)</span>
<span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Georeferenced records: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_coords</span><span class="p">)</span><span class="si">}</span><span class="s1"> across </span><span class="si">{</span><span class="n">df_coords</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s1"> species&#39;</span><span class="p">)</span>

<span class="n">species_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df_coords</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">species_list</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">hsl_to_hex</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">colorsys</span><span class="o">.</span><span class="n">hls_to_rgb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;#</span><span class="si">{:02x}{:02x}{:02x}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="mi">255</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="mi">255</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="mi">255</span><span class="p">))</span>

<span class="n">species_colours</span> <span class="o">=</span> <span class="p">{</span><span class="n">sp</span><span class="p">:</span> <span class="n">hsl_to_hex</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">n</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.42</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species_list</span><span class="p">)}</span>

<span class="n">overview_map</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span>
    <span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="mf">16.745</span><span class="p">,</span> <span class="o">-</span><span class="mf">62.202</span><span class="p">],</span> <span class="n">zoom_start</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">tiles</span><span class="o">=</span><span class="s1">&#39;OpenStreetMap&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s1">&#39;100%&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s1">&#39;500px&#39;</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_coords</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">sp</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;species&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">colour</span> <span class="o">=</span> <span class="n">species_colours</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="s1">&#39;#888888&#39;</span><span class="p">)</span>
    <span class="n">gbif_link</span> <span class="o">=</span> <span class="s1">&#39;https://www.gbif.org/occurrence/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;gbifID&#39;</span><span class="p">]))</span>
    <span class="n">year_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]))</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">))</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="n">inst_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;institutionCode&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="n">popup_html</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;&lt;b&gt;&lt;i&gt;</span><span class="si">{</span><span class="n">sp</span><span class="si">}</span><span class="s1">&lt;/i&gt;&lt;/b&gt;&lt;br&gt;</span><span class="si">{</span><span class="n">inst_str</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">year_str</span><span class="si">}</span><span class="s1">&lt;br&gt;&#39;</span>
        <span class="sa">f</span><span class="s1">&#39;&lt;a href=&quot;</span><span class="si">{</span><span class="n">gbif_link</span><span class="si">}</span><span class="s1">&quot; target=&quot;_blank&quot;&gt;GBIF record&lt;/a&gt;&#39;</span>
    <span class="p">)</span>
    <span class="n">folium</span><span class="o">.</span><span class="n">CircleMarker</span><span class="p">(</span>
        <span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;decimalLatitude&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;decimalLongitude&#39;</span><span class="p">]],</span>
        <span class="n">radius</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colour</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill_color</span><span class="o">=</span><span class="n">colour</span><span class="p">,</span>
        <span class="n">fill_opacity</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span>
        <span class="n">popup</span><span class="o">=</span><span class="n">folium</span><span class="o">.</span><span class="n">Popup</span><span class="p">(</span><span class="n">popup_html</span><span class="p">,</span> <span class="n">max_width</span><span class="o">=</span><span class="mi">220</span><span class="p">),</span>
        <span class="n">tooltip</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;&lt;i&gt;</span><span class="si">{</span><span class="n">sp</span><span class="si">}</span><span class="s1">&lt;/i&gt;&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">overview_map</span><span class="p">)</span>

<span class="n">legend_items</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="sa">f</span><span class="s1">&#39;&lt;span style=&quot;color:</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">;&quot;&gt;&amp;#9679;&lt;/span&gt; &lt;i&gt;</span><span class="si">{</span><span class="n">sp</span><span class="si">}</span><span class="s1">&lt;/i&gt;&lt;br&gt;&#39;</span>
    <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">species_colours</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
<span class="p">)</span>
<span class="n">legend_html</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;&lt;div style=&quot;position:fixed; bottom:20px; left:20px; z-index:9999;&#39;</span>
    <span class="s1">&#39; background:white; padding:10px 14px; border-radius:6px;&#39;</span>
    <span class="s1">&#39; border:1px solid #ccc; font-size:11px; line-height:1.8;&#39;</span>
    <span class="s1">&#39; max-height:280px; overflow-y:auto;&quot;&gt;&#39;</span>
    <span class="s1">&#39;&lt;b&gt;Species&lt;/b&gt;&lt;br&gt;&#39;</span> <span class="o">+</span> <span class="n">legend_items</span> <span class="o">+</span> <span class="s1">&#39;&lt;/div&gt;&#39;</span>
<span class="p">)</span>
<span class="n">overview_map</span><span class="o">.</span><span class="n">get_root</span><span class="p">()</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">folium</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="n">legend_html</span><span class="p">))</span>
<span class="n">overview_map</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;maps/montserrat_overview.html&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saved maps/montserrat_overview.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ---- Generate per-language _config, _toc, intro files ----</span>

<span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">active_langs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="n">lang_name</span> <span class="o">=</span> <span class="n">get_lang_name</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>
    <span class="n">lang_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;taxa_</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">&#39;</span>
    
    <span class="c1"># Build sorted taxa file list for this language</span>
    <span class="n">toc_taxa_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="p">[{</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lang_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">tn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span> <span class="k">for</span> <span class="n">tn</span> <span class="ow">in</span> <span class="n">taxonpages</span><span class="o">.</span><span class="n">keys</span><span class="p">()],</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    
    <span class="c1"># Organisation chapters (shared across languages)</span>
    <span class="n">org_chapters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;organisation&#39;</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">fname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.md&#39;</span><span class="p">):</span>
            <span class="n">org_chapters</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;organisation/</span><span class="si">{</span><span class="n">fname</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
    
    <span class="c1"># ---- _toc_{lang}.yml ----</span>
    <span class="n">toc_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;jb-book&#39;</span><span class="p">,</span>
        <span class="s1">&#39;root&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;intro_</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;parts&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;caption&#39;</span><span class="p">:</span> <span class="s1">&#39;Collections with grasses and sedges from Montserrat&#39;</span><span class="p">,</span>
                <span class="s1">&#39;chapters&#39;</span><span class="p">:</span> <span class="n">org_chapters</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s1">&#39;caption&#39;</span><span class="p">:</span> <span class="s1">&#39;Taxa originally from Montserrat&#39;</span><span class="p">,</span>
                <span class="s1">&#39;chapters&#39;</span><span class="p">:</span> <span class="n">toc_taxa_sorted</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
    
    <span class="n">toc_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;_toc_</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">.yml&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">toc_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">toc_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">allow_unicode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="c1"># ---- _config_{lang}.yml ----</span>
    <span class="n">config_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Grasses and sedges of Montserrat (</span><span class="si">{</span><span class="n">lang_name</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;author&#39;</span><span class="p">:</span> <span class="s1">&#39;Sofie Meeus, Quentin Groom, Andra Waagmeester&#39;</span><span class="p">,</span>
        <span class="s1">&#39;logo&#39;</span><span class="p">:</span> <span class="s1">&#39;logo.png&#39;</span><span class="p">,</span>
        <span class="s1">&#39;execute&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;execute_notebooks&#39;</span><span class="p">:</span> <span class="s1">&#39;off&#39;</span>  <span class="c1"># No execution — pages are pre-generated markdown</span>
        <span class="p">},</span>
        <span class="s1">&#39;latex&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;latex_documents&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;targetname&#39;</span><span class="p">:</span> <span class="s1">&#39;book.tex&#39;</span><span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;bibtex_bibfiles&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;references.bib&#39;</span><span class="p">],</span>
        <span class="s1">&#39;repository&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;https://github.com/VisibleNatureAtlas/Grasses-and-sedges-of-Montserrat&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path_to_book&#39;</span><span class="p">:</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;branch&#39;</span><span class="p">:</span> <span class="s1">&#39;main&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;html&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;use_issues_button&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;use_repository_button&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;extra_navbar&#39;</span><span class="p">:</span> <span class="s1">&#39;Powered by &lt;a href=&quot;https://jupyterbook.org&quot;&gt;Jupyter Book&lt;/a&gt;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;extra_footer&#39;</span><span class="p">:</span> <span class="p">(</span>
                <span class="s1">&#39;&lt;p&gt;Data sourced from &lt;a href=&quot;https://www.gbif.org/&quot;&gt;GBIF&lt;/a&gt; and &#39;</span>
                <span class="s1">&#39;&lt;a href=&quot;https://www.wikidata.org/&quot;&gt;Wikidata&lt;/a&gt; under open licenses. &#39;</span>
                <span class="s1">&#39;Maps </span><span class="se">\u00a9</span><span class="s1"> &lt;a href=&quot;https://www.openstreetmap.org/copyright&quot;&gt;OpenStreetMap&lt;/a&gt; contributors.&lt;/p&gt;&#39;</span>
            <span class="p">)</span>
        <span class="p">},</span>
        <span class="s1">&#39;sphinx&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;html_show_copyright&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;exclude_patterns&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;node_modules&#39;</span><span class="p">,</span> <span class="s1">&#39;myenv&#39;</span><span class="p">,</span> <span class="s1">&#39;_build&#39;</span><span class="p">,</span> <span class="s1">&#39;maps&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;GrassesMontserrat&#39;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1"># Also exclude other language taxa dirs to avoid confusion</span>
    <span class="k">for</span> <span class="n">other_lang</span> <span class="ow">in</span> <span class="n">active_langs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">other_lang</span> <span class="o">!=</span> <span class="n">lang</span><span class="p">:</span>
            <span class="n">config_data</span><span class="p">[</span><span class="s1">&#39;sphinx&#39;</span><span class="p">][</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="s1">&#39;exclude_patterns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;taxa_</span><span class="si">{</span><span class="n">other_lang</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># Exclude the old taxa/ dir too</span>
    <span class="n">config_data</span><span class="p">[</span><span class="s1">&#39;sphinx&#39;</span><span class="p">][</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="s1">&#39;exclude_patterns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;taxa&#39;</span><span class="p">)</span>
    
    <span class="n">config_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;_config_</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">.yml&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">allow_unicode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="c1"># ---- intro_{lang}.md ----</span>
    <span class="c1"># Count Wikipedia coverage for this language</span>
    <span class="n">n_with_wiki</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_langs</span><span class="p">[</span><span class="n">lang</span><span class="p">])</span>
    <span class="n">n_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">taxonpages</span><span class="p">)</span>
    
    <span class="n">intro_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;# Visible Nature Atlas: Grasses and sedges of Montserrat&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;*</span><span class="si">{</span><span class="n">lang_name</span><span class="si">}</span><span class="s1"> edition* </span><span class="se">\u2014</span><span class="s1"> Species descriptions from [</span><span class="si">{</span><span class="n">lang_name</span><span class="si">}</span><span class="s1"> Wikipedia](https://</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">.wikipedia.org/).&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="s1">&#39;This is a volume in the **Visible Nature Atlas** series </span><span class="se">\u2014</span><span class="s1"> an open, data-driven collection of &#39;</span>
        <span class="s1">&#39;biodiversity books covering the flora and fauna of specific regions worldwide.&#39;</span>
    <span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="c1"># Language picker</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;## Other language editions&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">other_editions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ol</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">active_langs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">ol</span> <span class="o">!=</span> <span class="n">lang</span><span class="p">:</span>
            <span class="n">ol_name</span> <span class="o">=</span> <span class="n">get_lang_name</span><span class="p">(</span><span class="n">ol</span><span class="p">)</span>
            <span class="n">n_ol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_langs</span><span class="p">[</span><span class="n">ol</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;en&#39;</span><span class="p">:</span>
                <span class="c1"># English is at root, other langs are subdirectories</span>
                <span class="n">other_editions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">ol_name</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">n_ol</span><span class="si">}</span><span class="s1"> species)](</span><span class="si">{</span><span class="n">ol</span><span class="si">}</span><span class="s1">/index.html)&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ol</span> <span class="o">==</span> <span class="s1">&#39;en&#39;</span><span class="p">:</span>
                <span class="c1"># Link back to English at the root</span>
                <span class="n">other_editions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">ol_name</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">n_ol</span><span class="si">}</span><span class="s1"> species)](../index.html)&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Between two non-English languages</span>
                <span class="n">other_editions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">ol_name</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">n_ol</span><span class="si">}</span><span class="s1"> species)](../</span><span class="si">{</span><span class="n">ol</span><span class="si">}</span><span class="s1">/index.html)&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">other_editions</span><span class="p">:</span>
        <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; </span><span class="se">\u00b7</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other_editions</span><span class="p">))</span>
        <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;## About this atlas&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="s1">&#39;This atlas documents the **grasses (Poaceae) and sedges (Cyperaceae)** of **Montserrat**, a small &#39;</span>
        <span class="s1">&#39;British Overseas Territory in the Caribbean Lesser Antilles. Despite its modest size (102 km</span><span class="se">\u00b2</span><span class="s1">), &#39;</span>
        <span class="s1">&#39;Montserrat harbours a rich diversity of native and introduced grass and sedge species.&#39;</span>
    <span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;This edition includes Wikipedia descriptions for **</span><span class="si">{</span><span class="n">n_with_wiki</span><span class="si">}</span><span class="s1">** out of </span><span class="si">{</span><span class="n">n_total</span><span class="si">}</span><span class="s1"> species.&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="c1"># Overview map — intro is the root page, so maps/ is a sibling directory (no ../)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;## Observations on Montserrat&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;```</span><span class="si">{raw}</span><span class="s1"> html&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;iframe src=&quot;maps/montserrat_overview.html&quot;&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;        width=&quot;100%&quot; height=&quot;520px&quot;&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;        frameborder=&quot;0&quot; scrolling=&quot;no&quot;&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;        style=&quot;border-radius:8px; margin-bottom:0.5rem;&quot;&gt;&lt;/iframe&gt;&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;```&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="s1">&#39;Map data </span><span class="se">\u00a9</span><span class="s1"> [OpenStreetMap](https://www.openstreetmap.org/copyright) contributors. &#39;</span>
        <span class="s1">&#39;Occurrence data from [GBIF](https://www.gbif.org/).&#39;</span>
    <span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="c1"># Wikipedia language availability table</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;## Wikipedia language availability&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="s1">&#39;The table below shows which species have Wikipedia articles in each language. &#39;</span>
        <span class="s1">&#39;Click a language code to visit the Wikipedia article.&#39;</span>
    <span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wiki_table_md</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="c1"># Data sources</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;## Data sources&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;| Source | Role |&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;|--------|------|&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;| **[GBIF](https://www.gbif.org/)** | Occurrence records |&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;| **[Wikidata](https://www.wikidata.org/)** | Taxonomic identifiers, metadata |&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;| **[Wikipedia](https://</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">.wikipedia.org/)** | Species descriptions |&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;| **[Plazi TreatmentBank](https://plazi.org/)** | Taxonomic treatments |&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;| **[BHL](https://www.biodiversitylibrary.org/)** | Historical literature |&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;| **[OpenStreetMap](https://www.openstreetmap.org/)** | Map tiles |&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;## Authors&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;- **Sofie Meeus** </span><span class="se">\u2014</span><span class="s1"> [Meise Botanic Garden](https://www.botanicgarden.be/)&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;- **Quentin Groom** </span><span class="se">\u2014</span><span class="s1"> [Meise Botanic Garden](https://www.botanicgarden.be/)&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;- **Andra Waagmeester** </span><span class="se">\u2014</span><span class="s1"> [Gene Wiki](https://www.wikidata.org/wiki/User:Andrawaag)&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;```</span><span class="si">{note}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;The interactive maps require JavaScript to be enabled in your browser.&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;```&#39;</span><span class="p">)</span>
    <span class="n">intro_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="n">intro_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;intro_</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">.md&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intro_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">intro_lines</span><span class="p">))</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">config_path</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">toc_path</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">intro_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Generated configs for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">active_langs</span><span class="p">)</span><span class="si">}</span><span class="s1"> languages.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ---- Write .languages.txt for the build script ----</span>
<span class="n">sorted_langs_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">active_langs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;.languages.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sorted_langs_list</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Wrote .languages.txt with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_langs_list</span><span class="p">)</span><span class="si">}</span><span class="s1"> languages: </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sorted_langs_list</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Done! Ready to build </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_langs_list</span><span class="p">)</span><span class="si">}</span><span class="s1"> language editions. English will be the default.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-the-local-rdf-graph">Load the local RDF graph</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-functions">Helper functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generate-folium-map-for-a-species">Generate Folium map for a species</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-taxa-information-from-the-rdf-graph">Load taxa information from the RDF graph</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-discover-available-wikipedia-languages">Step 1: Discover available Wikipedia languages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-fetch-language-independent-data-gbif-maps-plazi-bhl">Step 2: Fetch language-independent data (GBIF, maps, Plazi, BHL)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4-generate-montserrat-overview-map-per-language-configs">Step 4: Generate Montserrat overview map + per-language configs</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Sofie Meeus, Quentin Groom, Andra Waagmeester
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <p>Data sourced from <a href="https://www.gbif.org/">GBIF</a> and <a href="https://www.wikidata.org/">Wikidata</a> under open licenses. Maps © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors.</p>
</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>