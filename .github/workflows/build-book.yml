name: Build and Deploy Jupyter Book

on:
  push:
    branches:
      - main
  workflow_dispatch:  # allow manual triggering

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run data pipeline (inspectData.ipynb)
      run: |
        jupyter execute inspectData.ipynb --timeout=600

    - name: Generate multilingual taxa pages (generateTaxaPages.ipynb)
      env:
        BHL_API_KEY: ${{ secrets.BHL_API_KEY }}
      run: |
        jupyter execute generateTaxaPages.ipynb --timeout=1800

    - name: Build all language editions
      run: |
        # Read the list of languages generated by the notebook
        if [ ! -f .languages.txt ]; then
          echo "ERROR: .languages.txt not found — generateTaxaPages.ipynb did not run correctly"
          exit 1
        fi

        # Create the deploy directory with a landing page
        mkdir -p _deploy
        cp _build_landing.html _deploy/index.html
        touch _deploy/.nojekyll

        # Build each language edition
        while IFS= read -r lang || [ -n "$lang" ]; do
          [ -z "$lang" ] && continue
          echo ""
          echo "========================================="
          echo "Building language: $lang"
          echo "========================================="

          jupyter-book build . \
            --config "_config_${lang}.yml" \
            --toc "_toc_${lang}.yml" \
            --path-output "_build/${lang}"

          # Find the HTML output (path varies by jupyter-book version)
          HTML_DIR=""
          if [ -f "_build/${lang}/_build/html/index.html" ]; then
            HTML_DIR="_build/${lang}/_build/html"
          elif [ -f "_build/${lang}/html/index.html" ]; then
            HTML_DIR="_build/${lang}/html"
          else
            echo "ERROR: Build failed for language ${lang} — no index.html found"
            echo "Contents of _build/${lang}/:"
            find "_build/${lang}" -name "index.html" 2>/dev/null || echo "  (no index.html found)"
            ls -laR "_build/${lang}/" | head -50
            exit 1
          fi

          echo "Found HTML output at: ${HTML_DIR}"

          # Copy into deploy directory
          cp -r "${HTML_DIR}" "_deploy/${lang}"

          # Copy maps into each language's build
          cp -r maps/ "_deploy/${lang}/maps/"

          echo "Language ${lang} built successfully."
        done < .languages.txt

        echo ""
        echo "All language editions built. Deploy directory contents:"
        ls -la _deploy/
        for d in _deploy/*/; do
          echo "  ${d}: $(find "$d" -name '*.html' | wc -l) HTML files"
        done

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./_deploy
